
# Siew Chin's paper used 2004 census

# load both pri and sec plot data first # codes from growth manuscript 

# note that primary forest portions are not included


library(tidyverse)
library(fgeo.map)
library(fgeo.abundance)
library(fgeo.base)
library(fgeo.data)
library(fgeo.demography)
library(fgeo.tool)
# new R tables generated by Mauro
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/full/bukit_timah_primary.full6.rdata")
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/stem/bukit_timah_primary.stem6.rdata")
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/full/bukit_timah_secondary.full1.rdata")
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/full/bukit_timah_secondary.full2.rdata")
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/full/bukit_timah_secondary.full3.rdata")
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/stem/bukit_timah_secondary.stem1.rdata")
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/stem/bukit_timah_secondary.stem2.rdata")
load("/Users/KangMin/Dropbox/BT maps data/R_Tables/20180313_bukittimah/stem/bukit_timah_secondary.stem3.rdata")


# secplot checks # don't deal with multiple stems, too complicated
sec1.ori <- bukit_timah_secondary.full1
sec2.ori <- bukit_timah_secondary.full2
sec3.ori <- bukit_timah_secondary.full3
# all have same number of rows
sec3.ori$dbh[sec3.ori$dbh=="0"] <- NA # sec3agb DBH has 0mm 
# dead trees have no dbh # good
# 4 trees recorded dead in census 2 came back to life in census 3 # probably couldn't be found
# species are the same in all 3 censuses # good
# 1 missing tree in census 2, carried over to census 3, 8 more missing trees in census 3
mean(filter(sec1.ori, quadrat == "O2")$date, na.rm=T)
as.Date(16310, origin = "1960-01-01")
sec1.ori[is.na(sec1.ori$date),]$ExactDate <- "2004-08-27"
sec1.ori[is.na(sec1.ori$date),]$date <- 16310 # one date in census 1 is NA

# sec1[duplicated(sec1$tag) == T] # no duplicated tags
# sec2[duplicated(sec2$tag) == T]
# sec3[duplicated(sec3$tag) == T]

# corrections #
sec1.ori[sec1.ori$tag == "K4-01570",]$dbh <- 39.8 # clearly typo error
# move the coordinates of duplicate points by a little, because they cause problems for functions in spatstat
source("/Users/KangMin/Dropbox/secplot_recovery/R codes/xy_adjustments.R")
# corrections end

# add basal area column in m^2
sec1.ori$ba <- pi*(sec1.ori$dbh/ 1000 / 2)^2
sec2.ori$ba <- pi*(sec2.ori$dbh/ 1000 / 2)^2
sec3.ori$ba <- pi*(sec3.ori$dbh/ 1000 / 2)^2
# add size column
sec1.ori$size <- cut(sec1.ori$dbh, c(10,50,100,10000), include.lowest = T, right = F)
sec2.ori$size <- cut(sec2.ori$dbh, c(10,50,100,10000), include.lowest = T, right = F)
sec3.ori$size <- cut(sec3.ori$dbh, c(10,50,100,10000), include.lowest = T, right = F)
sec1.ori$size2 <- cut(sec1.ori$dbh, c(10,20,10000), include.lowest = T, right = T)
sec2.ori$size2 <- cut(sec2.ori$dbh, c(10,20,10000), include.lowest = T, right = T)
sec3.ori$size2 <- cut(sec3.ori$dbh, c(10,20,10000), include.lowest = T, right = T)
# add AGB calculated with Chave et al. 2015 equation
global_wsg <- read.csv("/Users/KangMin/Dropbox/secplot_recovery/R codes/GlobalWoodDensityDatabase_working.csv")
global_wsg <- subset(global_wsg, !is.na(spcode))
sp_wsg_mean <- data.frame(wsg=tapply(global_wsg$wsg_ind, global_wsg$spcode, mean))
# Chave et al. 2015 equation
ifelse(getwd()=="C:/Users/nkmst/Documents", load("C:/Users/nkmst/Dropbox/dendro Data analysis/E.RData"), load("/Users/KangMin/Dropbox/dendro Data analysis/E.RData"))
# assumes dbh in mm, wsg in g/cm^3, AGB in kg
chave2015 <- function(dbh, wsg){
  exp(-1.803 - (0.976*E) + (0.976*log(wsg)) + (2.673*log(dbh/10)) - (0.0299*log(dbh/10)^2))
}
sec1.ori$agb_chave2015 <- chave2015(sec1.ori$dbh, sp_wsg_mean[match(sec1.ori$sp, rownames(sp_wsg_mean)),])
sec2.ori$agb_chave2015 <- chave2015(sec2.ori$dbh, sp_wsg_mean[match(sec2.ori$sp, rownames(sp_wsg_mean)),])
sec3.ori$agb_chave2015 <- chave2015(sec3.ori$dbh, sp_wsg_mean[match(sec3.ori$sp, rownames(sp_wsg_mean)),])
# load pri6 data for comparison 
ifelse(getwd()=="C:/Users/nkmst/Documents", source("C:/Users/nkmst/Dropbox/secplot_recovery/R codes/priplot dynamics tidy.R"), source("/Users/KangMin/Dropbox/secplot_recovery/R codes/priplot dynamics tidy.R"))
pri6$agb_chave2015 <- chave2015(pri6$dbh, sp_wsg_mean[match(pri6$sp, rownames(sp_wsg_mean)),])
# add species classification, sourced from Tree Flora of Malaya, Wayside Trees of Malaya, Flora Malesiana, Plants of Southeast Asia website
sp_class <- read.csv("/Users/KangMin/Dropbox/secplot_recovery/R codes/sp_abundance_table.csv")
sec1.ori$sp_class <- sp_class[match(sec1.ori$sp, sp_class$sp),]$class
sec2.ori$sp_class <- sp_class[match(sec2.ori$sp, sp_class$sp),]$class
sec3.ori$sp_class <- sp_class[match(sec3.ori$sp, sp_class$sp),]$class
sec1.ori$sp_class2 <- sp_class[match(sec1.ori$sp, sp_class$sp),]$class2
sec2.ori$sp_class2 <- sp_class[match(sec2.ori$sp, sp_class$sp),]$class2
sec3.ori$sp_class2 <- sp_class[match(sec3.ori$sp, sp_class$sp),]$class2
# add dispersal 2 column
sec1.ori$dispersal1 <- sp_class[match(sec1.ori$sp, sp_class$sp),]$dispersal1
sec2.ori$dispersal1 <- sp_class[match(sec2.ori$sp, sp_class$sp),]$dispersal1
sec3.ori$dispersal1 <- sp_class[match(sec3.ori$sp, sp_class$sp),]$dispersal1
sec1.ori$dispersal2 <- sp_class[match(sec1.ori$sp, sp_class$sp),]$dispersal2
sec2.ori$dispersal2 <- sp_class[match(sec2.ori$sp, sp_class$sp),]$dispersal2
sec3.ori$dispersal2 <- sp_class[match(sec3.ori$sp, sp_class$sp),]$dispersal2
# trees alive in whole plot
sec1.ori.alive <- subset(sec1.ori, status == "A")
sec2.ori.alive <- subset(sec2.ori, status == "A")
sec3.ori.alive <- subset(sec3.ori, status == "A")

# remove quadrats K1, K2, K3, N1, O1, P1, L2, M2, N2, O2 # same as Siew Chin's manuscript
exclude <- c("K1", "K2", "K3", "N1", "O1", "P1", "L2", "M2", "N2", "O2")
sec1 <- subset(sec1.ori, !(quadrat %in% exclude))
sec2 <- subset(sec2.ori, !(quadrat %in% exclude))
sec3 <- subset(sec3.ori, !(quadrat %in% exclude))

# trees alive
sec1.alive <- subset(sec1, status == "A")
sec2.alive <- subset(sec2, status == "A")
sec3.alive <- subset(sec3, status == "A")
sec2.surv <- subset(sec2, status=="A" & tag %in% subset(sec1, status=="A")$tag) # survivors from census 1
sec3.surv <- subset(sec3, status=="A" & tag %in% subset(sec1, status=="A")$tag) # survivors from census 1

# create a combined file of all censuses with unique quadrat names corresponding to each census
# so that it's easy to create an abundance table for each species and each census
sec.alive <- rbind(sec1.alive, sec2.alive, sec3.alive)
sec.alive$quadrat.census <- c(paste(sec1.alive$quadrat, 1, sep = "."), paste(sec2.alive$quadrat, 2, sep = "."), paste(sec3.alive$quadrat, 3, sep = "."))





# check Siew Chin's files
sc_sec <- read.delim("C:/Users/nkmst/Dropbox/secplot_recovery/R codes/s1_1.txt")
sc_sec <- read.delim("/Users/KangMin/Dropbox/secplot_recovery/R codes/s1_1.txt")
sc_sec <- droplevels(subset(sc_sec, !(quadrat %in% exclude)))
nrow(subset(sc_sec, status=="A"))
nrow(subset(sc_sec, status=="A"))/40*25 # this is close to what I got
nrow(sec1.alive)/40*25
nrow(sc_sec)/40*25
table(subset(sc_sec, status=="A")$quadrat)
table(droplevels(subset(sc_sec, status=="A"))$sp) # only MACAHY is missing, a few other species have abundance discrepancies of 1 individual
table(sec1.alive$sp)
sc_sec$ba <- pi*(sc_sec$dbh/ 1000 / 2)^2
sum(sc_sec$ba, na.rm=T) / 40 * 25
sum(sec1.alive$ba, na.rm=T) / 40 * 25 # discrepancy
temp2 <- sec1.alive[FALSE,]
for (i in 1:nrow(sc_sec)){
  temp1 <- sec1.alive[match(sc_sec$tag[i], sec1.alive$tag),]
  if (!is.na(temp1$dbh)){
    if (sc_sec$dbh[i] == temp1$dbh) temp2 <- temp2
    if (sc_sec$dbh[i] != temp1$dbh) temp2 <- rbind(temp2, temp1)
  }
}
subset(sc_sec, tag=="K4-01570") # this is the problem, probably the problem disappeared as data from the later two censuses were used for checking
sort(tapply(sc_sec$ba, sc_sec$sp, sum, na.rm=T)) # using her file I'm getting exactly the same results as I did with my copy, so I'm not sure how she got the results in the supplementary materials she published in the 2013 paper





# species composition between censuses
# use hierarchical clustering to group all quadrats from all censuses
library(vegan)

sec.spec <- tapply(sec.alive$sp, list(sec.alive$quadrat.census, sec.alive$sp), length)
sec.spec[is.na(sec.spec)] <- 0
sec.dist <- vegdist(sec.spec, method = "bray")
sec.wardD <- hclust(sec.dist, "ward.D")
sec.wardD2 <- hclust(sec.dist, "ward.D2")

png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/hclust.png", res=100, width = 1800, height = 500)
plot(sec.wardD)
dev.off()
plot(sec.wardD2) # both methods show little plot-wide change in species composition, but census 3 is constantly more different than both census 1 and 2. 

# Diversity indices: Fisher's alpha, S
sec1.spec <- tapply(sec1.alive$sp, list(sec1.alive$quadrat, sec1.alive$sp), length); sec1.spec[is.na(sec1.spec)] <- 0
sec2.spec <- tapply(sec2.alive$sp, list(sec2.alive$quadrat, sec2.alive$sp), length); sec2.spec[is.na(sec2.spec)] <- 0
sec3.spec <- tapply(sec3.alive$sp, list(sec3.alive$quadrat, sec3.alive$sp), length); sec3.spec[is.na(sec3.spec)] <- 0
sec1.fisher <- fisher.alpha(sec1.spec); sec1.sha <- diversity(sec1.spec, "shannon")
sec2.fisher <- fisher.alpha(sec2.spec); sec2.sha <- diversity(sec2.spec, "shannon")
sec3.fisher <- fisher.alpha(sec3.spec); sec3.sha <- diversity(sec3.spec, "shannon")
wilcox.test(sec1.fisher, sec2.fisher, paired=T); wilcox.test(sec2.fisher, sec3.fisher, paired=T); wilcox.test(sec1.fisher, sec3.fisher, paired=T)
wilcox.test(sec1.sha, sec2.sha, paired=T); wilcox.test(sec2.sha, sec3.sha, paired=T); wilcox.test(sec1.sha, sec3.sha, paired=T)


# PCA
biplot(prcomp(sec.dist, scale=T))

# use NMDS to look at distances between quadrats from all censuses
library(MASS)
isoMDS(sec.dist) # error

# ANOSIM # may not be reliable
census <- rep(c("census1", "census2", "census3"), times=41)
sec.ano <- anosim(sec.dist, census)
summary(sec.ano)
plot(sec.ano)

# ADONIS # assumes that sites are interchangeable under a true null hypothesis, but mine are temporally correlated
adonis(sec.spec ~ census, permutations=100) # no significant differences between censuses
adonis(sec.dist ~ census, permutations=100)

# look at degree of similarity between censuses END


# species abundances
sort(table(sec1.alive$sp)); length(table(sec1.alive$sp))-2 # 125 species; minus AAAAAA and PANDDP
sort(table(sec2.alive$sp)); length(table(sec2.alive$sp))-2 # 139 species (+14)
sort(table(sec3.alive$sp)); length(table(sec3.alive$sp))-2 # 148 species (+11)
# species ID of species that went 'extinct' from plot, and newly recruited species
table(sec3.alive$sp)[match(names(table(sec1.alive$sp)), names(table(sec3.alive$sp)))] # DIOSBU (1), ELAEPU (1), MACAGF (1), STE2FB (1, recruited in 2008), MEMEOL (1, recruited in 2008) went 'extinct'
table(sec1.alive$sp)[match(names(table(sec3.alive$sp)), names(table(sec1.alive$sp)))] # APORBE (1), APORFA (1), BHESRO (2), CALOIN (1), CANAPI (3), CASECL (1), CASTWA (1), DIOSCS (1), DIOSST (2), ELAENI (4), GARCSC (2), GONTMA (1; same as GONIMA, which was not present in secplot), HORSPF (1), HORSPO (1), KNEMLA (1), LINDLU (2), LITHCA (1), LITSFI (4), MACAGI (1), MACALO (1), PAR1IN (1), PHAEOP (2), SANDBE (2), TEIJCO (1), UROPGL (1), VITEPI (1)
# number of species in each species class
table(as.data.frame(cbind(sp=unique(sec1.alive$sp), sp_class=as.character(sp_class[match(unique(sec1.alive$sp), sp_class$sp),"class"])))$sp_class)
table(as.data.frame(cbind(sp=unique(sec2.alive$sp), sp_class=as.character(sp_class[match(unique(sec2.alive$sp), sp_class$sp),"class"])))$sp_class)
table(as.data.frame(cbind(sp=unique(sec3.alive$sp), sp_class=as.character(sp_class[match(unique(sec3.alive$sp), sp_class$sp),"class"])))$sp_class)
table(as.data.frame(cbind(sp=unique(sec1.alive$sp), sp_class=as.character(sp_class[match(unique(sec1.alive$sp), sp_class$sp),"class2"])))$sp_class)
table(as.data.frame(cbind(sp=unique(sec2.alive$sp), sp_class=as.character(sp_class[match(unique(sec2.alive$sp), sp_class$sp),"class2"])))$sp_class)
table(as.data.frame(cbind(sp=unique(sec3.alive$sp), sp_class=as.character(sp_class[match(unique(sec3.alive$sp), sp_class$sp),"class2"])))$sp_class)
# mean species richness in each quadrat
no.sp.quad1 <- numeric()
for (i in 1:40){
  quad <- levels(factor(sec1.alive$quadrat))[i]
  temp1 <- subset(sec1.alive, quadrat == quad & sp !="AAAAAA")
  no.sp.quad1[i] <- length(table(temp1$sp))
}
# poster figure: no. species in each species class in 2004, 2008 and 2012 
sp_class_sp <- cbind( table(as.data.frame(cbind(sp=unique(sec1.alive$sp), sp_class=as.character(sp_class[match(unique(sec1.alive$sp), sp_class$sp),"class"])))$sp_class), table(as.data.frame(cbind(sp=unique(sec2.alive$sp), sp_class=as.character(sp_class[match(unique(sec2.alive$sp), sp_class$sp),"class"])))$sp_class), table(as.data.frame(cbind(sp=unique(sec3.alive$sp), sp_class=as.character(sp_class[match(unique(sec3.alive$sp), sp_class$sp),"class"])))$sp_class)  )
dimnames(sp_class_sp)[[2]] <- c("2004", "2008", "2012")
png("C:/Users/nkmst/Dropbox/secplot_recovery/ESJ_2017_poster/sp_class_sp.png", width=500, height=600)
par(mar=c(5.1, 4.5, 4.1, 2.1))
barplot(sp_class_sp, ylim=c(0,200), ylab="No. species", main="No. species", cex.axis = 2, cex.names = 2, cex.lab=2, cex.main=2)
# legend=c("exotic species", "primary forest species", "primary + secondary forest species", "secondary forest species"), args.legend = list(x=3, y=200, bty="n", y.intersp = 0.8, cex=2), 
dev.off()
# combine these into one table # refer to sp_abundance_table.xlsx


# stem density
# whole plot
nrow(sec1.alive)
nrow(sec2.alive)
nrow(sec3.alive) # no major changes in stem density, which means that losses in species are balanced by gains in other species
# per ha
nrow(sec1.alive)/40*25
nrow(sec2.alive)/40*25
nrow(sec3.alive)/40*25
# 95% CI by bootstrapping quadrats
ind1.quad <- tapply(sec1.alive$sp, sec1.alive$quadrat, length) * 25
ind2.quad <- tapply(sec2.alive$sp, sec2.alive$quadrat, length) * 25
ind3.quad <- tapply(sec3.alive$sp, sec3.alive$quadrat, length) * 25
ind1.sim <- numeric()
ind2.sim <- numeric()
ind3.sim <- numeric()
for (i in 1:1000){
  temp <- sample(1:40, 40, replace=T)
  ind1.sim[i] <- mean(ind1.quad[temp])
  ind2.sim[i] <- mean(ind2.quad[temp])
  ind3.sim[i] <- mean(ind3.quad[temp])
}
quantile(ind1.sim, c(0.025, 0.975)); mean(ind1.sim)
quantile(ind2.sim, c(0.025, 0.975)); mean(ind2.sim)
quantile(ind3.sim, c(0.025, 0.975)); mean(ind3.sim)
# by size class per ha
table(sec1.alive$size)/40*25
table(sec2.alive$size)/40*25
table(sec3.alive$size)/40*25
quad1.size <- tapply(sec1.alive$size, list(sec1.alive$quadrat, sec1.alive$size), length)
quad2.size <- tapply(sec2.alive$size, list(sec2.alive$quadrat, sec2.alive$size), length)
quad3.size <- tapply(sec3.alive$size, list(sec3.alive$quadrat, sec3.alive$size), length)
sec1.ind.size <- as.list(numeric(1000)); sec2.ind.size <- as.list(numeric(1000)); sec3.ind.size <- as.list(numeric(1000)); 
for (i in 1:1000){
  a <- sample(seq(1,40), 40, replace=T)
  sec1.ind.size[[i]] <- colSums(quad1.size[a,])/40*25
  sec2.ind.size[[i]] <- colSums(quad2.size[a,])/40*25
  sec3.ind.size[[i]] <- colSums(quad3.size[a,])/40*25
}
sec1.ind.size <- data.frame(matrix(unlist(sec1.ind.size), nrow=1000, byrow=T), stringsAsFactors=FALSE)
sec2.ind.size <- data.frame(matrix(unlist(sec2.ind.size), nrow=1000, byrow=T), stringsAsFactors=FALSE)
sec3.ind.size <- data.frame(matrix(unlist(sec3.ind.size), nrow=1000, byrow=T), stringsAsFactors=FALSE)
colSums(quad1.size)/40*25; apply(sec1.ind.size, MARGIN=2, quantile, c(0.025, 0.975))
colSums(quad2.size)/40*25; apply(sec2.ind.size, MARGIN=2, quantile, c(0.025, 0.975))
colSums(quad3.size)/40*25; apply(sec3.ind.size, MARGIN=2, quantile, c(0.025, 0.975))
# by species per ha
sort(table(sec1.alive$sp))/40*25
sort(table(sec2.alive$sp))/40*25
sort(table(sec3.alive$sp))/40*25
# by species class per ha
table(sec1.alive$sp_class)/40*25
table(sec2.alive$sp_class)/40*25
table(sec3.alive$sp_class)/40*25
table(sec1.alive$sp_class2)/40*25
table(sec2.alive$sp_class2)/40*25
table(sec3.alive$sp_class2)/40*25
# poster figure: no. individuals in each species class in 2004, 2008 and 2012 
sp_class_ind <- cbind(table(sec1.alive$sp_class)/40*25, table(sec2.alive$sp_class)/40*25, table(sec3.alive$sp_class)/40*25 )
dimnames(sp_class_ind)[[2]] <- c("2004", "2008", "2012")
png("C:/Users/nkmst/Dropbox/secplot_recovery/ESJ_2017_poster/sp_class_ind.png", width=500, height=600)
par(mar=c(5.1, 4.5, 4.1, 2.1))
barplot(sp_class_ind, ylim=c(0,2500), ylab="No. individuals", main="No. individuals", legend=c("exotic species", "primary forest species", "primary + secondary forest species", "secondary forest species"), args.legend = list(x=4, y=2600, bty="n", y.intersp = 0.8, cex=2), cex.axis = 2, cex.names = 2, cex.lab=2, cex.main=2)
dev.off()
# stem density END

# basal area per ha
sum(sec1.alive$ba, na.rm=T) / 40 * 25
sum(sec2.alive$ba, na.rm=T) / 40 * 25
sum(sec3.alive$ba, na.rm=T) / 40 * 25
# 95% CI by bootstrapping quadrats
ba1.quad <- tapply(sec1.alive$ba, sec1.alive$quadrat, sum, na.rm=T) * 25
ba2.quad <- tapply(sec2.alive$ba, sec2.alive$quadrat, sum, na.rm=T) * 25
ba3.quad <- tapply(sec3.alive$ba, sec3.alive$quadrat, sum, na.rm=T) * 25
ba1.sim <- numeric()
ba2.sim <- numeric()
ba3.sim <- numeric()
for (i in 1:1000){
  temp <- sample(1:40, 40, replace=T)
  ba1.sim[i] <- mean(ba1.quad[temp])
  ba2.sim[i] <- mean(ba2.quad[temp])
  ba3.sim[i] <- mean(ba3.quad[temp])
}
quantile(ba1.sim, c(0.025, 0.975)); mean(ba1.sim)
quantile(ba2.sim, c(0.025, 0.975)); mean(ba2.sim)
quantile(ba3.sim, c(0.025, 0.975)); mean(ba3.sim)
# basal area by species per ha
sort(tapply(sec1.alive$ba, sec1.alive$sp, sum, na.rm=T)) / 40 * 25
sort(tapply(sec2.alive$ba, sec2.alive$sp, sum, na.rm=T)) / 40 * 25
sort(tapply(sec3.alive$ba, sec3.alive$sp, sum, na.rm=T)) / 40 * 25
# basal area by species class
tapply(sec1.alive$ba, sec1.alive$sp_class, sum, na.rm=T) / 40 * 25
tapply(sec2.alive$ba, sec2.alive$sp_class, sum, na.rm=T) / 40 * 25
tapply(sec3.alive$ba, sec3.alive$sp_class, sum, na.rm=T) / 40 * 25
tapply(sec1.alive$ba, sec1.alive$sp_class2, sum, na.rm=T) / 40 * 25
tapply(sec2.alive$ba, sec2.alive$sp_class2, sum, na.rm=T) / 40 * 25
tapply(sec3.alive$ba, sec3.alive$sp_class2, sum, na.rm=T) / 40 * 25
# poster figure: basal area in each species class in 2004, 2008 and 2012 
sp_class_ba <- cbind(tapply(sec1.alive$ba, sec1.alive$sp_class, sum, na.rm=T) / 40 * 25, tapply(sec2.alive$ba, sec2.alive$sp_class, sum, na.rm=T) / 40 * 25, tapply(sec3.alive$ba, sec3.alive$sp_class, sum, na.rm=T) / 40 * 25 )
dimnames(sp_class_ba)[[2]] <- c("2004", "2008", "2012")
png("C:/Users/nkmst/Dropbox/secplot_recovery/ESJ_2017_poster/sp_class_ba.png", width=500, height=600)
par(mar=c(5.1, 5.4, 4.1, 2.1))
barplot(sp_class_ba, ylim=c(0,30), ylab=expression(paste("Basal area", (m^2/ha))), main="Basal area",  cex.axis = 2, cex.names = 2, cex.lab=2, cex.main=2)
# legend=c("exotic species", "primary forest species", "primary + secondary forest species", "secondary forest species"), args.legend = list(x=3, y=30, bty="n", y.intersp = 0.8, cex=2),
dev.off()
# basal area END

# AGB per ha
# original unit is in kg
sum(sec1.alive$agb_chave2015, na.rm=T) / 40 * 25 / 1000
sum(sec2.alive$agb_chave2015, na.rm=T) / 40 * 25 / 1000
sum(sec3.alive$agb_chave2015, na.rm=T) / 40 * 25 / 1000
# 95% CI by bootstrapping quadrats
agb1.quad <- tapply(sec1.alive$agb_chave2015, sec1.alive$quadrat, sum, na.rm=T) * 25
agb2.quad <- tapply(sec2.alive$agb_chave2015, sec2.alive$quadrat, sum, na.rm=T) * 25
agb3.quad <- tapply(sec3.alive$agb_chave2015, sec3.alive$quadrat, sum, na.rm=T) * 25
agb1.sim <- numeric()
agb2.sim <- numeric()
agb3.sim <- numeric()
for (i in 1:1000){
  temp <- sample(1:40, 40, replace=T)
  agb1.sim[i] <- mean(agb1.quad[temp])
  agb2.sim[i] <- mean(agb2.quad[temp])
  agb3.sim[i] <- mean(agb3.quad[temp])
}
quantile(agb1.sim, c(0.025, 0.975)) / 1000; mean(agb1.sim) / 1000
quantile(agb2.sim, c(0.025, 0.975)) / 1000; mean(agb2.sim) / 1000
quantile(agb3.sim, c(0.025, 0.975)) / 1000; mean(agb3.sim) / 1000
# compare with pri6 AGB
sum(pri6$agb_chave2015, na.rm=T) / 2 / 1000 # sec3 AGB was 52.5% of pri6 AGB

# AGB END


# dispersal syndromes in each species class # species with >=10 individuals
sec1_10 <- table(sec1.alive$sp)[table(sec1.alive$sp)>=10][-1] # remove AAAAAA
sec2_10 <- table(sec2.alive$sp)[table(sec2.alive$sp)>=10]
sec3_10 <- table(sec3.alive$sp)[table(sec3.alive$sp)>=10]
# no. species
sec1_sp <- as.data.frame(cbind(sp=names(sec1_10), sp_class=as.character(sp_class[match(names(sec1_10), sp_class$sp),]$class), dispersal2=as.character(sp_class[match(names(sec1_10), sp_class$sp),]$dispersal2)))
sec2_sp <- as.data.frame(cbind(sp=names(sec2_10), sp_class=as.character(sp_class[match(names(sec2_10), sp_class$sp),]$class), dispersal2=as.character(sp_class[match(names(sec2_10), sp_class$sp),]$dispersal2)))
sec3_sp <- as.data.frame(cbind(sp=names(sec3_10), sp_class=as.character(sp_class[match(names(sec3_10), sp_class$sp),]$class), dispersal2=as.character(sp_class[match(names(sec3_10), sp_class$sp),]$dispersal2)))
tapply(sec1_sp$dispersal2, list(sec1_sp$dispersal2, sec1_sp$sp_class), length)
tapply(sec2_sp$dispersal2, list(sec2_sp$dispersal2, sec2_sp$sp_class), length)
tapply(sec3_sp$dispersal2, list(sec3_sp$dispersal2, sec3_sp$sp_class), length)
# no. individuals
tapply(sec1.alive$dispersal2, list(sec1.alive$dispersal2, sec1.alive$sp_class), length)
tapply(sec2.alive$dispersal2, list(sec2.alive$dispersal2, sec2.alive$sp_class), length)
tapply(sec3.alive$dispersal2, list(sec3.alive$dispersal2, sec3.alive$sp_class), length)
# dispersal syndromes in each species class END




# examine species in primary forest portion
sec1.pri <- subset(sec1.ori, quadrat %in% exclude & status == "A")
sec2.pri <- subset(sec2.ori, quadrat %in% exclude & status == "A")
sec3.pri <- subset(sec3.ori, quadrat %in% exclude & status == "A")
sort(table(sec1.pri$sp))
# examine species in primary forest portion END







# mortality and recruitment
mortality(sec1, sec2)
mortality(sec2, sec3)
recruitment(sec1, sec2)
recruitment(sec2, sec3)
# # delete if not needed anymore
# # 99.9% CI by bootstrapping quadrats to account for spatial autocorrelation
# mort12.quad <- mortality(sec1, sec2, split1 = sec1$quadrat)$rate
# mort23.quad <- mortality(sec2, sec3, split1 = sec2$quadrat)$rate
# recr12.quad <- recruitment(sec1, sec2, split1 = sec1$quadrat)$rate
# recr23.quad <- recruitment(sec2, sec3, split1 = sec2$quadrat)$rate
# mort12.sim <- numeric()
# mort23.sim <- numeric()
# recr12.sim <- numeric()
# recr23.sim <- numeric()
# for (i in 1:1000){
#   temp <- sample(1:40, 40, replace=T)
#   mort12.sim[i] <- mean(mort12.quad[temp])
#   mort23.sim[i] <- mean(mort23.quad[temp])
#   recr12.sim[i] <- mean(recr12.quad[temp])
#   recr23.sim[i] <- mean(recr23.quad[temp])
# }
# mortality(sec1, sec2)$rate; mean(mort12.quad) # similar
# mortality(sec2, sec3)$rate; mean(mort23.quad) # quadrat level much higher
# recruitment(sec1, sec2)$rate; mean(recr12.quad) # mean of quadrat is lower than direct calculation
# recruitment(sec2, sec3)$rate; mean(recr23.quad) # quadrat level much higher
# must be because of spatial autocorrelation because the patterns are inconsistent between intervals
# quantile(mort12.sim, c(0.0005, 0.9995)); mean(mort12.sim)
# quantile(mort23.sim, c(0.0005, 0.9995)); mean(mort23.sim) # mean of bootstrap higher than actual mean
# quantile(recr12.sim, c(0.0005, 0.9995)); mean(recr12.sim) # mean of bootstrap lower than actual mean
# quantile(recr23.sim, c(0.0005, 0.9995)); mean(recr23.sim) # mean of bootstrap higher than actual mean
# # delete if not needed anymore ### 
# by species
mortality(sec1, sec2, split1 = sec1$sp)$rate
mortality(sec2, sec3, split1 = sec2$sp)$rate
recruitment(sec1, sec2, split1 = sec1$sp)$rate
recruitment(sec2, sec3, split1 = sec2$sp)$rate
mortality(sec1, sec3, split1 = sec1$sp)$rate
recruitment(sec1, sec3, split1 = sec1$sp)$rate
# by size
mortality(sec1, sec2, split1 = sec1$size)
mortality(sec2, sec3, split1 = sec2$size)
# # delete if not needed anymore
# mort12.size.sim <- mortality(sec1, sec2, split1=sec1$size, split2=sec1$quadrat)$rate
# mort23.size.sim <- mortality(sec2, sec3, split1=sec2$size, split2=sec2$quadrat)$rate
# mort.size.ci12 <- as.list(numeric(1000)); mort.size.ci23 <- as.list(numeric(1000))
# for (i in 1:1000){
#   a <- sample(seq(1:40), size=40, replace=T)
#   mort.size.ci12[[i]] <- rowMeans(mort12.size.sim[,a])
#   mort.size.ci23[[i]] <- rowMeans(mort23.size.sim[,a])
# }
# mort.size.ci12 <- data.frame(matrix(unlist(mort.size.ci12), nrow=1000, byrow=T), stringsAsFactors=FALSE)
# mort.size.ci23 <- data.frame(matrix(unlist(mort.size.ci23), nrow=1000, byrow=T), stringsAsFactors=FALSE)
# apply(mort.size.ci12, MARGIN=2, quantile, c(0.0005, 0.9995)); mortality(sec1, sec2, split1 = sec1$size)$rate
# apply(mort.size.ci23, MARGIN=2, quantile, c(0.0005, 0.9995)); mortality(sec2, sec3, split1 = sec2$size)$rate
# # delete if not needed anymore ###
# by species and size
mort12_sp_size <- mortality(sec1, sec2, split1 = sec1$sp, split2 = sec1$size)
mort12_sp_size$rate[rownames(mort12_sp_size$rate) %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI"),]
mort12_sp_size$N[rownames(mort12_sp_size$N) %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI"),]
mort23_sp_size <- mortality(sec2, sec3, split1 = sec2$sp, split2 = sec2$size)
mort23_sp_size$rate[rownames(mort23_sp_size$rate) %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI"),]
mort23_sp_size$N[rownames(mort23_sp_size$N) %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI"),]
recruitment(sec1, sec2, split1 = sec1$sp)$rate
recruitment(sec2, sec3, split1 = sec2$sp)$rate
# by species class
mortality(sec1, sec2, split1 = sec1$sp_class)
mortality(sec2, sec3, split1 = sec2$sp_class)
recruitment(sec1, sec2, split1 = sec1$sp_class)
recruitment(sec2, sec3, split1 = sec2$sp_class)
mortality(sec1, sec2, split1 = sec1$sp_class2)
mortality(sec2, sec3, split1 = sec2$sp_class2)
recruitment(sec1, sec2, split1 = sec1$sp_class2)
recruitment(sec2, sec3, split1 = sec2$sp_class2)
# mortality and recruitment END




# dominant species
splist <- read.delim("C:/Users/nkmst/Dropbox/Front Royal 2013/Hokkaido/splist.txt")
splist <- read.delim("/Users/KangMin/Dropbox/Front Royal 2013/Hokkaido/splist.txt")
sort(tapply(sec1$ba, sec1$sp, sum, na.rm=T), decreasing=T)[1:10]
top10_2004 <- names(sort(tapply(sec1$ba, sec1$sp, sum, na.rm=T), decreasing=T)[1:10])
table(subset(sec1.alive, sp %in% top10_2004)$sp)
tapply(subset(sec3, sp %in% top10_2004)$ba, subset(sec3, sp %in% top10_2004)$sp, sum, na.rm=T)
table(subset(sec3.alive, sp %in% top10_2004)$sp)
mortality(sec1, sec3, split1=sec1$sp)$rate[names(mortality(sec1, sec3, split1=sec1$sp)$rate) %in% top10_2004]
recruitment(sec1, sec3, split1=sec1$sp)$rate[names(recruitment(sec1, sec3, split1=sec1$sp)$rate) %in% top10_2004]
# test of change in abundance between census 1 and 3, using quadrat as replicate, paired Wilcoxon signed-rank test
sec1.adindu <- subset(sec1.alive, sp == "ADINDU"); sec3.adindu <- subset(sec3.alive, sp == "ADINDU")
sec1.campau <- subset(sec1.alive, sp == "CAMPAU"); sec3.campau <- subset(sec3.alive, sp == "CAMPAU")
sec1.dillsu <- subset(sec1.alive, sp == "DILLSU"); sec3.dillsu <- subset(sec3.alive, sp == "DILLSU")
sec1.rhodci <- subset(sec1.alive, sp == "RHODCI"); sec3.rhodci <- subset(sec3.alive, sp == "RHODCI")
sec1.adindu.quad <- tapply(sec1.adindu$size, list(sec1.adindu$quadrat, sec1.adindu$size), length)
sec3.adindu.quad <- tapply(sec3.adindu$size, list(sec3.adindu$quadrat, sec3.adindu$size), length)
sec1.campau.quad <- tapply(sec1.campau$size, list(sec1.campau$quadrat, sec1.campau$size), length)
sec3.campau.quad <- tapply(sec3.campau$size, list(sec3.campau$quadrat, sec3.campau$size), length)
sec1.dillsu.quad <- tapply(sec1.dillsu$size, list(sec1.dillsu$quadrat, sec1.dillsu$size), length)
sec3.dillsu.quad <- tapply(sec3.dillsu$size, list(sec3.dillsu$quadrat, sec3.dillsu$size), length)
sec1.rhodci.quad <- tapply(sec1.rhodci$size, list(sec1.rhodci$quadrat, sec1.rhodci$size), length)
sec3.rhodci.quad <- tapply(sec3.rhodci$size, list(sec3.rhodci$quadrat, sec3.rhodci$size), length)
cbind(sec1.adindu.quad[,2], sec3.adindu.quad[,2], sec1.adindu.quad[,3], sec3.adindu.quad[,3])
cbind(sec1.campau.quad[,2], sec3.campau.quad[,2], sec1.campau.quad[,3], sec3.campau.quad[,3])
wilcox.test(sec1.adindu.quad[,1], sec3.adindu.quad[,1], paired=T) # sample size too small
wilcox.test(sec1.adindu.quad[,2], sec3.adindu.quad[,2], paired=T) # ***
wilcox.test(sec1.adindu.quad[,3], sec3.adindu.quad[,3], paired=T) # >=10.0 cm size class no difference
wilcox.test(sec1.campau.quad[,1], sec3.campau.quad[,1], paired=T) # sample size too small
wilcox.test(sec1.campau.quad[,2], sec3.campau.quad[,2], paired=T) # sample size too small
wilcox.test(sec1.campau.quad[,3], sec3.campau.quad[,3], paired=T) # ***
wilcox.test(sec1.dillsu.quad[,1], sec3.dillsu.quad[,1], paired=T) # ***
wilcox.test(sec1.dillsu.quad[,2], sec3.dillsu.quad[,2], paired=T) # ***
wilcox.test(sec1.dillsu.quad[,3], sec3.dillsu.quad[,3], paired=T) # >=10.0 cm size class no difference
wilcox.test(sec1.rhodci.quad[,1], sec3.rhodci.quad[,1], paired=T) # *
wilcox.test(sec1.rhodci.quad[,2], sec3.rhodci.quad[,2], paired=T) # no difference
wilcox.test(sec1.rhodci.quad[,3], sec3.rhodci.quad[,3], paired=T) # no difference
# plot of 4 dominant species abundance in census 1 and 3
four_dom_sp <- rbind(subset(sec1.alive, sp %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI")), subset(sec3.alive, sp %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI")))
four_dom_sp_mat1 <- tapply(four_dom_sp$size, list(four_dom_sp$size, four_dom_sp$CensusID, four_dom_sp$sp), length)
adindu_mat <- matrix(four_dom_sp_mat1[1:6], nrow=3, byrow=F, dimnames=list(c("[10,50)", "[50,100)", "[100,1e+04]"), c("2004", "2012")))
campau_mat <- matrix(four_dom_sp_mat1[7:12], nrow=3, byrow=F, dimnames=list(c("[10,50)", "[50,100)", "[100,1e+04]"), c("2004", "2012")))
dillsu_mat <- matrix(four_dom_sp_mat1[13:18], nrow=3, byrow=F, dimnames=list(c("[10,50)", "[50,100)", "[100,1e+04]"), c("2004", "2012")))
rhodci_mat <- matrix(four_dom_sp_mat1[19:24], nrow=3, byrow=F, dimnames=list(c("[10,50)", "[50,100)", "[100,1e+04]"), c("2004", "2012")))
png("/Users/KangMin/Dropbox/secplot_recovery/figures/dom_sp_abun.png", width=3700, height=3000, res=600)
par(mfrow=c(2,2))
barplot(t(adindu_mat), beside=T, xlab="dbh (cm)", ylab="No. individuals", ylim=c(0,420), main=expression(italic("Adinandra dumosa")), cex.axis = 1.2, cex.names = 1.2, cex.lab=1.4, cex.main=1.4, names=c("1.0-4.9", "5.0-9.9", expression("">="10.0")))
text(x=5, y=300, labels="***", cex=1.4)
barplot(t(campau_mat), beside=T, xlab="dbh (cm)", ylab="No. individuals", ylim=c(0,420), main=expression(italic("Campnosperma auriculatum")), cex.axis = 1.2, cex.names = 1.2, cex.lab=1.4, cex.main=1.4, names=c("1.0-4.9", "5.0-9.9", expression("">="10.0")))
text(x=8, y=300, labels="***", cex=1.4)
barplot(t(dillsu_mat), beside=T, xlab="dbh (cm)", ylab="No. individuals", ylim=c(0,420), main=expression(italic("Dillenia suffruticosa")), cex.axis = 1.2, cex.names = 1.2, cex.lab=1.4, cex.main=1.4, names=c("1.0-4.9", "5.0-9.9", expression("">="10.0")))
text(x=2, y=400, labels="***", cex=1.4); text(x=5, y=390, labels="***", cex=1.4)
barplot(t(rhodci_mat), beside=T, xlab="dbh (cm)", ylab="No. individuals", ylim=c(0,420), main=expression(italic("Rhodamnia cinerea")), legend.text = c("2004", "2012"), args.legend = list(x=6, y=450, bty="n", y.intersp=0.8, cex=1.4), cex.axis = 1.2, cex.names = 1.2, cex.lab=1.4, cex.main=1.4, names=c("1.0-4.9", "5.0-9.9", expression("">="10.0")))
text(x=2, y=100, labels="*", cex=1.4)
dev.off()
# figure for poster 
png("C:/Users/nkmst/Dropbox/secplot_recovery/ESJ_2017_poster/dom_sp_abun.png", width=1000, height=700)
par(mfrow=c(2,2), mar=c(5.1, 4.5, 4.1, 2.1))
barplot(adindu_mat, beside=T, ylab="No. individuals", ylim=c(0,400), main=expression(italic("Adinandra dumosa")), cex.axis = 2, cex.names = 2, cex.lab=2, cex.main=2.4)
barplot(campau_mat, beside=T, ylab="No. individuals", ylim=c(0,400), main=expression(italic("Campnosperma auriculata")), cex.axis = 2, cex.names = 2, cex.lab=2, cex.main=2.4)
barplot(dillsu_mat, beside=T, ylab="No. individuals", ylim=c(0,400), main=expression(italic("Dillenia suffruticosa")), cex.axis = 2, cex.names = 2, cex.lab=2, cex.main=2.4)
barplot(rhodci_mat, beside=T, ylab="No. individuals", ylim=c(0,400), main=expression(italic("Rhodamnia cinerea")), legend.text = c("1.0-4.9 cm", "5.0-9.9 cm", expression("">="10 cm")), args.legend = list(x=4, y=400, bty="n", y.intersp=2, cex=2), cex.axis = 2, cex.names = 2, cex.lab=2, cex.main=2.4)
dev.off()
# dominant species END


# primary forest species
sort(table(subset(sec1.alive, sp_class=="PF")$sp))
sort(table(subset(sec2.alive, sp_class=="PF")$sp))
sort(table(subset(sec3.alive, sp_class=="PF")$sp))
sort(table(subset(sec1.alive, sp_class2=="PF")$sp))
sort(table(subset(sec2.alive, sp_class2=="PF")$sp))
sort(table(subset(sec3.alive, sp_class2=="PF")$sp))
# primary forest species END
# generalist species
sort(table(subset(sec1.alive, sp_class=="PFSF")$sp))
sort(table(subset(sec2.alive, sp_class=="PFSF")$sp))
sort(table(subset(sec3.alive, sp_class=="PFSF")$sp))
# generalist species END


# species classes in priplot
pri6_sp <- read.csv("C:/Users/nkmst/Dropbox/secplot_recovery/R codes/pri6.alive.sp.csv")
names(pri6_sp)
table(pri6_sp$sp_class2)
table(as.data.frame(cbind(sp=unique(sec3.alive$sp), sp_class=as.character(sp_class[match(unique(sec3.alive$sp), sp_class$sp),"class2"])))$sp_class)
# species classes in priplot END



# primary forest and generalist species combined 
sort(table(subset(sec1.alive, sp_class %in% c("PF", "PFSF"))$sp))
sort(table(subset(sec2.alive, sp_class %in% c("PF", "PFSF"))$sp))
sort(table(subset(sec3.alive, sp_class %in% c("PF", "PFSF"))$sp))
# No. individuals
pf_gen_ind <- rbind(table(subset(sec1.alive, sp_class %in% c("PF", "PFSF"))$sp_class)/40*25, table(subset(sec2.alive, sp_class %in% c("PF", "PFSF"))$sp_class)/40*25, table(subset(sec3.alive, sp_class %in% c("PF", "PFSF"))$sp_class)/40*25)
pf_gen_ind <- pf_gen_ind[,2:3]
rownames(pf_gen_ind) <- c("2004", "2008", "2012")
colnames(pf_gen_ind) <- c("Primary forest species", "Generalist species")
# No. individuals END
# basal area
pf_gen_ba <- rbind(tapply(sec1.alive$ba, sec1.alive$sp_class, sum, na.rm=T)/40*25, tapply(sec2.alive$ba, sec2.alive$sp_class, sum, na.rm=T)/40*25, tapply(sec3.alive$ba, sec3.alive$sp_class, sum, na.rm=T)/40*25)
pf_gen_ba <- pf_gen_ba[,2:3]
rownames(pf_gen_ba) <- c("2004", "2008", "2012")
colnames(pf_gen_ba) <- c("Primary forest species", "Generalist species")
# basal area END
# No. species
pf_gen_no.sp <- rbind(table(as.data.frame(cbind(sp=unique(sec1.alive$sp), sp_class=as.character(sp_class[match(unique(sec1.alive$sp), sp_class$sp),"class"])))$sp_class), table(as.data.frame(cbind(sp=unique(sec2.alive$sp), sp_class=as.character(sp_class[match(unique(sec2.alive$sp), sp_class$sp),"class"])))$sp_class), table(as.data.frame(cbind(sp=unique(sec3.alive$sp), sp_class=as.character(sp_class[match(unique(sec3.alive$sp), sp_class$sp),"class"])))$sp_class))
pf_gen_no.sp <- pf_gen_no.sp[,2:3]
rownames(pf_gen_no.sp) <- c("2004", "2008", "2012")
colnames(pf_gen_no.sp) <- c("Primary forest species", "Generalist species")
# No. species END
# barplots
png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/PF_PFSF_ind_ba_sp.png", width=500, height=900, res=100)
par(mfrow=c(3,1), mar=c(3, 4.1, 2.1, 0.5)) 
barplot(pf_gen_ind, beside=T, ylim=c(0,1000), ylab="", cex.axis=1.5, cex.names=1.5, legend=c("2004", "2008", "2012"), args.legend=list(x=3, y=1000, bty="n", cex=1.5)); mtext(text="No. individuals/ha", side=2, line=2.5)
barplot(pf_gen_ba, beside=T, ylim=c(0,20), cex.axis=1.5, cex.names=1.5); mtext(text=expression(paste("Basal area", (m^2/ha))), side=2, line=2)
barplot(pf_gen_no.sp, beside=T, ylim=c(0,100), cex.axis=1.5, cex.names=1.5); mtext(text="No. species", side=2, line=2.5)
dev.off()
# barplots END
# primary forest and generalist species combined END





# no. trees in each size2 in each sp_class2
table(sec1.alive$size, sec1.alive$sp_class2)
table(sec1.alive$size2, sec1.alive$sp_class2)
# no. trees in each size class in each sp_class2 END





# spatial distribution of non-pioneer saplings (1-2cm dbh)
sap.nonpio2 <- subset(sec2.alive, sp_class2 == "non_pioneer" & dbh <= 20)
sap.nonpio3 <- subset(sec3.alive, sp_class2 == "non_pioneer" & dbh <= 20)
png("/Users/KangMin/Dropbox/secplot_recovery/figures/non_pio_sap_map_2008.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(sap.nonpio2$gx, sap.nonpio2$gy, xlim=c(0,100), ylim=c(0,200), asp=1, main = "Sapling (1-2cm dbh) distribution")
points(sap.nonpio3$gx, sap.nonpio3$gy, pch = 16)
legend(x = -3, y = 70, legend = c("2008", "2012"), pch = c(1,16), bty = "n")
dev.off()
# spatial distribution of non-pioneer recruits (1-2cm dbh) END






# get nearest neighbour for each sapling per species # idea from Nate Swenson
# 1. for each species, separate saplings (1-2 cm) from bigger trees, and then for each sapling, look for nearest non-sapling and calculate its distance. 
# 2. repeat above but randomize sapling sp and position.
# 3. get distribution of distances of nearest bigger tree. 
smalls_all <- subset(sec3.alive, dbh <= 20) # subset only those species with saplings
sec3.with.sap <- subset(sec3.alive, sp %in% smalls_all$sp & !is.na(dbh)) # code below does not accept broken trees

# generates distance matrices between saplings and bigger trees
for (i in 1:length(table(sec3.with.sap$sp))){
  sec3.with.sap_sp <- filter(sec3.with.sap, sp == names(table(sec3.with.sap$sp))[i])
  if (nrow(sec3.with.sap_sp) == 1) {next}
  matt <- as.matrix(dist(cbind(sec3.with.sap_sp$gx, sec3.with.sap_sp$gy)))
  colnames(matt) = rownames(matt) = sec3.with.sap_sp$tag
  
  bigs = filter(sec3.with.sap_sp, dbh > 50)$tag
  smalls = filter(sec3.with.sap_sp, dbh <=20)$tag
  
  if (length(bigs) == 0 | length(smalls) == 0) {next}
  
  sm.matt = matt[smalls,bigs]
  if (is.null(nrow(sm.matt))) {
    obs = as.matrix(min(sm.matt))
    write.csv(obs, paste("/Users/KangMin/Dropbox/secplot_recovery/R codes/sapling nearest neighbour 2012/within sp/", names(table(sec3.with.sap$sp))[i], ".csv", sep=""), row.names=T, quote=F)
    next;
  } 

  obs = as.matrix(apply(sm.matt, 1, min, na.rm=T))
  
  write.csv(obs, paste("/Users/KangMin/Dropbox/secplot_recovery/R codes/sapling nearest neighbour 2012/within sp/", names(table(sec3.with.sap$sp))[i], ".csv", sep=""), row.names=T, quote=F)
}

# randomization of sapling identity
# for each species, separate saplings from bigger trees

timestamp() # takes about 7 minutes 
for (i in 1:length(table(sec3.with.sap$sp))){
  sec3.with.sap_sp <- filter(sec3.with.sap, sp == names(table(sec3.with.sap$sp))[i])
  if (nrow(sec3.with.sap_sp) == 1) {next}
  
  bigs <- filter(sec3.with.sap_sp, dbh > 50)$tag
  smalls <- filter(sec3.with.sap_sp, dbh <= 20)$tag
  
  if (length(bigs) == 0 | length(smalls) == 0) {next} 
  
  obs_ran <- matrix(nrow=length(smalls), ncol=1000)
  # randomize sapling identity
  for (j in 1:1000){
    smalls <- sec3.with.sap[sample(row.names(smalls_all), length(smalls), replace=F),]$tag
    
    sec3.with.sap_ran <- rbind(subset(sec3.with.sap_sp, dbh > 50), subset(sec3.with.sap, tag %in% smalls))
    matt <- as.matrix(dist(cbind(sec3.with.sap_ran$gx, sec3.with.sap_ran$gy)))
    colnames(matt) = rownames(matt) = sec3.with.sap_ran$tag
    
    sm.matt = matt[smalls,bigs]
    if (is.null(nrow(sm.matt))) {
      obs_ran[,j] = min(sm.matt)
      next;
    }
    
    obs_ran[,j] = as.matrix(apply(sm.matt, 1, min, na.rm=T)) 
  }

  write.csv(obs_ran, paste("/Users/KangMin/Dropbox/secplot_recovery/R codes/sapling nearest neighbour 2012/randomized sp/", names(table(sec3.with.sap$sp))[i], "_ran.csv", sep=""), row.names=T,quote=F)
  
}
timestamp() # takes about 7 minutes

# insert observed nearest neighbour on the front of the randomized table, and rank each row
sp_files <- list.files("/Users/KangMin/Dropbox/secplot_recovery/R codes/sapling nearest neighbour 2012/within sp/")
sp_ran_files <- list.files("/Users/KangMin/Dropbox/secplot_recovery/R codes/sapling nearest neighbour 2012/randomized sp/")
# put each species file into a list
mindist.sp <- as.list(substr(sp_files, 1, nchar(sp_files)-4))
mindist.sp_ran <- as.list(substr(sp_ran_files, 1, nchar(sp_ran_files)-4))
for (i in 1:length(mindist.sp)){
  mindist.sp[[i]] <- read.csv(paste("/Users/KangMin/Dropbox/secplot_recovery/R codes/sapling nearest neighbour 2012/within sp/", sp_files[i], sep=""))
  mindist.sp_ran[[i]] <- read.csv(paste("/Users/KangMin/Dropbox/secplot_recovery/R codes/sapling nearest neighbour 2012/randomized sp/", sp_ran_files[i], sep=""))
}
sap.rank <- vector("list", length(mindist.sp))
sap.rank.summary <- matrix(data=NA, nrow=length(sp_files), ncol=6, dimnames=list(substr(sp_files, 1,6), names(summary(c(1:10)))))
SES <- vector("list", length(mindist.sp))


for (i in 1:length(mindist.sp)){
  mindist.sp[[i]] <- mindist.sp[[i]][,-1] # remove first column of tag numbers
  mindist.sp_ran[[i]] <- mindist.sp_ran[[i]][,-1] # remove first column of numbers
  bigtable.sp <- cbind(mindist.sp[[i]], mindist.sp_ran[[i]])
  
  for (j in 1:nrow(bigtable.sp)){
    sap.rank[[i]][j] <- rank(bigtable.sp[j,])[1]
    SES[[i]][j] <- (mindist.sp[[i]] - rowMeans(mindist.sp_ran[[i]][j,])) / sd(mindist.sp_ran[[i]][j,])
  }
  sap.rank.summary[i,] <- summary(sap.rank[[i]])
}

write.csv(sap.rank.summary, "/Users/KangMin/Dropbox/secplot_recovery/R codes/sap.rank.summary.csv")

mean_SES <- as.data.frame(cbind(sp = substr(sp_files, 1,6), meanSES = unlist(lapply(SES, mean))))

# get nearest neighbour for each sapling per non-pioneer species END


# standardized error calculation # Nate Swenson
# SES = (obs - row_mean) / sd_row


# standardized effect sizes calculation # Nate Swenson # END








# spatial distribution of non-pioneer trees in whole plot # 2012
# BACCSU, CALOBM, CALOPC, CALOTY, CALOWA, EUGELO, GARCGR, GYNOAX, SHORCU, STREEL
# select(filter(sec3.ori.alive, sp == "BACCSU"), tag:date) # using tidyverse
sec3.ori.baccsu <- subset(sec3.ori.alive, sp == "BACCSU")
sec3.ori.calobm <- subset(sec3.ori.alive, sp == "CALOBM")
sec3.ori.calopc <- subset(sec3.ori.alive, sp == "CALOPC")
sec3.ori.caloty <- subset(sec3.ori.alive, sp == "CALOTY")
sec3.ori.calowa <- subset(sec3.ori.alive, sp == "CALOWA")
sec3.ori.eugelo <- subset(sec3.ori.alive, sp == "EUGELO")
sec3.ori.garcgr <- subset(sec3.ori.alive, sp == "GARCGR")
sec3.ori.gynoax <- subset(sec3.ori.alive, sp == "GYNOAX")
sec3.ori.shorcu <- subset(sec3.ori.alive, sp == "SHORCU")
sec3.ori.streel <- subset(sec3.ori.alive, sp == "STREEL")

png("/Users/KangMin/Dropbox/secplot_recovery/figures/baccsu_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.baccsu, dbh > 50)$gx, subset(sec3.ori.baccsu, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.baccsu, dbh > 50)$dbh/15, main = expression(italic("Baccaurea sumatrana")))
points(subset(sec3.ori.baccsu, dbh <= 20)$gx, subset(sec3.ori.baccsu, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.baccsu, dbh <= 20)$dbh/15)
legend(x=10, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/calobm_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.calobm, dbh > 50)$gx, subset(sec3.ori.calobm, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.calobm, dbh > 50)$dbh/15, main = expression(italic("Calophyllum ferrugineum")))
points(subset(sec3.ori.calobm, dbh <= 20)$gx, subset(sec3.ori.calobm, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.calobm, dbh <= 20)$dbh/15)
# legend(x=20, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/calopc_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.calopc, dbh > 50)$gx, subset(sec3.ori.calopc, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.calopc, dbh > 50)$dbh/15, main = expression(italic("Calophyllum pulcherrimum")))
points(subset(sec3.ori.calopc, dbh <= 20)$gx, subset(sec3.ori.calopc, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.calopc, dbh <= 20)$dbh/15)
# legend(x=20, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/caloty_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.caloty, dbh > 50)$gx, subset(sec3.ori.caloty, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.caloty, dbh > 50)$dbh/15, main = expression(italic("Calophyllum teijsmannii")))
points(subset(sec3.ori.caloty, dbh <= 20)$gx, subset(sec3.ori.caloty, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.caloty, dbh <= 20)$dbh/15)
# legend(x=20, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/calowa_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.calowa, dbh > 50)$gx, subset(sec3.ori.calowa, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.calowa, dbh > 50)$dbh/15, main = expression(italic("Calophyllum wallichianum")))
points(subset(sec3.ori.calowa, dbh <= 20)$gx, subset(sec3.ori.calowa, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.calowa, dbh <= 20)$dbh/15)
legend(x=10, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/eugelo_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.eugelo, dbh > 50)$gx, subset(sec3.ori.eugelo, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.eugelo, dbh > 50)$dbh/15, main = expression(italic("Syzygium lineatum")))
points(subset(sec3.ori.eugelo, dbh <= 20)$gx, subset(sec3.ori.eugelo, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.eugelo, dbh <= 20)$dbh/15)
# legend(x=20, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/garcgr_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.garcgr, dbh > 50)$gx, subset(sec3.ori.garcgr, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.garcgr, dbh > 50)$dbh/15, main = expression(italic("Garcinia griffithii")))
points(subset(sec3.ori.garcgr, dbh <= 20)$gx, subset(sec3.ori.garcgr, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.garcgr, dbh <= 20)$dbh/15)
legend(x=10, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/gynoax_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.gynoax, dbh > 50)$gx, subset(sec3.ori.gynoax, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.gynoax, dbh > 50)$dbh/15, main = expression(italic("Gynotroches axillaris")))
points(subset(sec3.ori.gynoax, dbh <= 20)$gx, subset(sec3.ori.gynoax, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.gynoax, dbh <= 20)$dbh/15)
# legend(x=20, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/shorcu_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.shorcu, dbh > 50)$gx, subset(sec3.ori.shorcu, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.shorcu, dbh > 50)$dbh/15, main = expression(italic("Shorea curtisii")))
points(subset(sec3.ori.shorcu, dbh <= 20)$gx, subset(sec3.ori.shorcu, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.shorcu, dbh <= 20)$dbh/15)
# legend(x=20, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

png("/Users/KangMin/Dropbox/secplot_recovery/figures/streel_map_2012.png", width=564, height=1031, res = 150)
par(xaxs="i", yaxs="i")
plot(subset(sec3.ori.streel, dbh > 50)$gx, subset(sec3.ori.streel, dbh > 50)$gy, xlim=c(0,100), ylim=c(0,200), xlab="X", ylab="Y", asp=1, cex=subset(sec3.ori.streel, dbh > 50)$dbh/15, main = expression(italic("Streblus elongatus")))
points(subset(sec3.ori.streel, dbh <= 20)$gx, subset(sec3.ori.streel, dbh <= 20)$gy, pch = 16, cex=subset(sec3.ori.streel, dbh <= 20)$dbh/15)
# legend(x=20, y=200, legend=c("sapling (1-2cm dbh)", "bigger trees (>5cm dbh)"), pch = c(16,1), bty="n")
dev.off()

# spatial distribution of non-pioneer trees in whole plot END








# dynamics of species classes 
# 95% CI by bootstrapping quadrats
sp_class_ind_1.quad <- tapply(sec1.alive$sp_class, list(sec1.alive$quadrat, sec1.alive$sp_class), length) * 25
sp_class_ind_1.quad[is.na(sp_class_ind_1.quad)] <- 0
sp_class_ind_2.quad <- tapply(sec2.alive$sp_class, list(sec2.alive$quadrat, sec2.alive$sp_class), length) * 25
sp_class_ind_2.quad[is.na(sp_class_ind_2.quad)] <- 0
sp_class_ind_3.quad <- tapply(sec3.alive$sp_class, list(sec3.alive$quadrat, sec3.alive$sp_class), length) * 25
sp_class_ind_3.quad[is.na(sp_class_ind_3.quad)] <- 0
sp_class_ind_1.sim <- matrix(nrow=1000, ncol=4)
sp_class_ind_2.sim <- matrix(nrow=1000, ncol=4)
sp_class_ind_3.sim <- matrix(nrow=1000, ncol=4)
for (i in 1:1000){
  temp <- sample(1:40, 40, replace=T)
  sp_class_ind_1.sim[i,] <- colMeans(sp_class_ind_1.quad[temp,])
  sp_class_ind_2.sim[i,] <- colMeans(sp_class_ind_2.quad[temp,])
  sp_class_ind_3.sim[i,] <- colMeans(sp_class_ind_3.quad[temp,])
}
apply(sp_class_ind_1.sim, MARGIN=2, quantile, c(0.025, 0.975))
apply(sp_class_ind_2.sim, MARGIN=2, quantile, c(0.025, 0.975))
apply(sp_class_ind_3.sim, MARGIN=2, quantile, c(0.025, 0.975))
# create table for barplot
# No. individuals
sp_class_ind <- data.frame(ind = c(table(sec1.alive$sp_class)/40*25, table(sec2.alive$sp_class)/40*25, table(sec3.alive$sp_class)/40*25), sp_class = rep(c("Exotic", "Primary forest", "Generalist", "Secondary forest"), 3), census = rep(c("2004", "2008", "2012"), each=4), ci_lower = c(apply(sp_class_ind_1.sim, MARGIN=2, quantile, c(0.025, 0.975))[1,], apply(sp_class_ind_2.sim, MARGIN=2, quantile, c(0.025, 0.975))[1,], apply(sp_class_ind_3.sim, MARGIN=2, quantile, c(0.025, 0.975))[1,]), ci_upper = c(apply(sp_class_ind_1.sim, MARGIN=2, quantile, c(0.025, 0.975))[2,], apply(sp_class_ind_2.sim, MARGIN=2, quantile, c(0.025, 0.975))[2,], apply(sp_class_ind_3.sim, MARGIN=2, quantile, c(0.025, 0.975))[2,]))
sp_class_ind$sp_class <- factor(sp_class_ind$sp_class, levels = levels(sp_class_ind$sp_class)[c(3,2,4,1)])
# No. individuals END
# basal area
# 95% CI by bootstrapping quadrats
sp_class_ba_1.quad <- tapply(sec1.alive$ba, list(sec1.alive$quadrat, sec1.alive$sp_class), sum, na.rm=T) * 25
sp_class_ba_1.quad[is.na(sp_class_ba_1.quad)] <- 0
sp_class_ba_2.quad <- tapply(sec2.alive$ba, list(sec2.alive$quadrat, sec2.alive$sp_class), sum, na.rm=T) * 25
sp_class_ba_2.quad[is.na(sp_class_ba_2.quad)] <- 0
sp_class_ba_3.quad <- tapply(sec3.alive$ba, list(sec3.alive$quadrat, sec3.alive$sp_class), sum, na.rm=T) * 25
sp_class_ba_3.quad[is.na(sp_class_ba_3.quad)] <- 0
sp_class_ba_1.sim <- matrix(nrow=1000, ncol=4)
sp_class_ba_2.sim <- matrix(nrow=1000, ncol=4)
sp_class_ba_3.sim <- matrix(nrow=1000, ncol=4)
for (i in 1:1000){
  temp <- sample(1:40, 40, replace=T)
  sp_class_ba_1.sim[i,] <- colMeans(sp_class_ba_1.quad[temp,])
  sp_class_ba_2.sim[i,] <- colMeans(sp_class_ba_2.quad[temp,])
  sp_class_ba_3.sim[i,] <- colMeans(sp_class_ba_3.quad[temp,])
}
apply(sp_class_ba_1.sim, MARGIN=2, quantile, c(0.025, 0.975))
apply(sp_class_ba_2.sim, MARGIN=2, quantile, c(0.025, 0.975))
apply(sp_class_ba_3.sim, MARGIN=2, quantile, c(0.025, 0.975))
# create table for barplot
sp_class_ba <- data.frame(ba = c(tapply(sec1.alive$ba, sec1.alive$sp_class, sum, na.rm=T)/40*25, tapply(sec2.alive$ba, sec2.alive$sp_class, sum, na.rm=T)/40*25, tapply(sec3.alive$ba, sec3.alive$sp_class, sum, na.rm=T)/40*25), sp_class = rep(c("Exotic", "Primary forest", "Generalist", "Secondary forest"), 3), census = rep(c("2004", "2008", "2012"), each=4), ci_lower = c(apply(sp_class_ba_1.sim, MARGIN=2, quantile, c(0.025, 0.975))[1,], apply(sp_class_ba_2.sim, MARGIN=2, quantile, c(0.025, 0.975))[1,], apply(sp_class_ba_3.sim, MARGIN=2, quantile, c(0.025, 0.975))[1,]), ci_upper = c(apply(sp_class_ba_1.sim, MARGIN=2, quantile, c(0.025, 0.975))[2,], apply(sp_class_ba_2.sim, MARGIN=2, quantile, c(0.025, 0.975))[2,], apply(sp_class_ba_3.sim, MARGIN=2, quantile, c(0.025, 0.975))[2,]))
sp_class_ba$sp_class <- factor(sp_class_ba$sp_class, levels = levels(sp_class_ba$sp_class)[c(3,2,4,1)])
# basal area END
# barplots
library(plyr)
library(ggplot2)
plot_ind <- ggplot(sp_class_ind, aes(x=sp_class, y=ind, fill=census)) + 
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=ind-ci_lower, ymax=ind+ci_upper), width=.2, position=position_dodge(.9)) + 
  scale_fill_grey(start = 0.2, end = 0.8) + 
  theme_bw() + 
  theme(axis.text.x  = element_text(vjust=0.5, size=12), axis.text.y  = element_text(vjust=0.5, size=12)) + 
  xlab("Species type") + 
  ylab("No. trees (/ha)")
plot_ba <- ggplot(sp_class_ba, aes(x=sp_class, y=ba, fill=census)) + 
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=ba-ci_lower, ymax=ba+ci_upper), width=.2, position=position_dodge(.9)) + 
  scale_fill_grey(start = 0.2, end = 0.8) + 
  theme_bw() + 
  theme(axis.text.x  = element_text(vjust=0.5, size=12), axis.text.y  = element_text(vjust=0.5, size=12)) + 
  xlab("Species type") + 
  ylab(expression("Basal area" (m^2/ha)))
png("/Users/KangMin/Dropbox/secplot_recovery/figures/sp_class_ind_ba.png", width=1000, height=600, res=100)
source("/Users/KangMin/Dropbox/secplot_recovery/R codes/multiplot.R")
multiplot(plot_ind, plot_ba)
dev.off()
# barplots END
# barplots OLDDD
png("/Users/KangMin/Dropbox/secplot_recovery/figures/sp_class_ind_ba.png", width=1000, height=600, res=100)
par(mfrow=c(2,1), mar=c(3, 4.1, 2.1, 0.5)) 
barplot(sp_class_ind, beside=T, ylim=c(0,1000), ylab="", cex.axis=1.2, cex.names=1.2); mtext(text="No. individuals/ha", side=2, line=2.5, cex=1.2)
barplot(sp_class_ba, beside=T, ylim=c(0,16), cex.axis=1.2, cex.names=1.2, legend=c("2004", "2008", "2012"), args.legend=list(x=15, y=15, bty="n", cex=1.5)); mtext(text=expression(paste("Basal area", (m^2/ha))), side=2, line=2, cex=1.2)
dev.off()
# barplots END OLDDD
# dynamics of species classes END





# number of species in each size class
table(subset(sec1, size=="[10,20)")$sp); length(table(subset(sec1, size=="[10,20)")$sp))
table(subset(sec1, size=="[20,100)")$sp); length(table(subset(sec1, size=="[20,100)")$sp))-1
table(subset(sec1, size=="[100,1e+04]")$sp); length(table(subset(sec1, size=="[100,1e+04]")$sp))-1
table(subset(sec2, size=="[10,20)")$sp); length(table(subset(sec2, size=="[10,20)")$sp))
table(subset(sec2, size=="[20,100)")$sp); length(table(subset(sec2, size=="[20,100)")$sp))-1
table(subset(sec2, size=="[100,1e+04]")$sp); length(table(subset(sec2, size=="[100,1e+04]")$sp))-1
table(subset(sec3, size=="[10,20)")$sp); length(table(subset(sec3, size=="[10,20)")$sp))
table(subset(sec3, size=="[20,100)")$sp); length(table(subset(sec3, size=="[20,100)")$sp))-1
table(subset(sec3, size=="[100,1e+04]")$sp); length(table(subset(sec3, size=="[100,1e+04]")$sp))-1
# number of species in each size class END



# plot distance from primary forest vs. no. individuals
dist_to_pri <- read.csv("C:/Users/nkmst/Dropbox/secplot_recovery/R codes/dist_to_rock_catchment_path.csv")
dist_to_pri <- read.csv("/Users/KangMin/Dropbox/secplot_recovery/R codes/dist_to_rock_catchment_path.csv")
dist_pri <- subset(dist_to_pri, !(quadrat %in% exclude))
dist_pri <- dist_pri[order(dist_pri$quadrat),]
dist_pri_ind1 <- cbind(dist_pri, t(tapply(sec1.alive$sp_class2, list(sec1.alive$sp_class2, sec1.alive$quadrat), length)))
dist_pri_ind1[is.na(dist_pri_ind1)] <- 0
dist_pri_ind3 <- cbind(dist_pri, t(tapply(sec3.alive$sp_class2, list(sec3.alive$sp_class2, sec3.alive$quadrat), length)))
dist_pri_ind3[is.na(dist_pri_ind3)] <- 0
dist_pri_ind1$census <- 2004; dist_pri_ind3$census <- 2012
dist_pri_ind <- rbind(dist_pri_ind1, dist_pri_ind3)
dist_pri_ind$census <- as.factor(dist_pri_ind$census)
# linear regression # should not be used for non-pioneer species, because it predicts negative abundance beyond a certain distance # but my model is not used for predictive purposes... 
summary(lm(pioneer ~ dist_to_path, data=dist_pri_ind1))
summary(lm(pioneer ~ dist_to_path, data=dist_pri_ind3))
summary(lm(non_pioneer ~ dist_to_path, data=dist_pri_ind1))
summary(lm(non_pioneer ~ dist_to_path, data=dist_pri_ind3))
summary(lm(pioneer ~ dist_to_path + census, data=dist_pri_ind)) # no difference in slope between censuses
summary(lm(non_pioneer ~ dist_to_path + census, data=dist_pri_ind)) # also no difference in slope for non_pioneers
# non-linear regression, using decay function
# y = a - exp(-b * x)
model_non_pio1 <- nls(non_pioneer ~ a * exp(-b * dist_to_path), data=dist_pri_ind1, start = list(a=85, b=0.02653141))
model_non_pio3 <- nls(non_pioneer ~ a * exp(-b * dist_to_path), data=dist_pri_ind3, start = list(a=100, b=0.034657))
summary(model_non_pio1); summary(model_non_pio3)

# plot distance from pri forest vs. no. individuals of pioneer & non_pioneer species
av1 <- seq(0, 120, length=40); bv1 <- predict(model_non_pio1, list(dist_to_path=av1))
av3 <- seq(0, 120, length=40); bv3 <- predict(model_non_pio3, list(dist_to_path=av3))
png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/dist_pri_pio_non_pio_ind.png", width=7000, height=2500, res=600)
par(mfrow=c(1,2))
plot(dist_pri_ind1$dist_to_path, dist_pri_ind1$non_pioneer, main="Non-pioneer species", xlab="Distance from primary forest (m)", ylab="No. trees", ylim=c(0,100), cex=1.5, cex.lab=1.5, cex.axis=1.5, cex.main=1.5)
points(dist_pri_ind3$dist_to_path, dist_pri_ind3$non_pioneer, pch=4, cex=1.5)
abline(lm(non_pioneer ~ dist_to_path, data=dist_pri_ind1), lwd=1.5)
abline(lm(non_pioneer ~ dist_to_path, data=dist_pri_ind3), lty=2, lwd=1.5)
# lines(av1, bv1, lwd=1.5); lines(av3, bv3, lty=2, lwd=1.5)
legend(x=80, y=110, legend=c("2004", "2012"), lty=c(1,2), pch=c(1,4), bty=1, cex=1.3, pt.cex=1.5)
mtext("a", side=3, line=1, at=5, cex=1.5)
plot(dist_pri_ind1$dist_to_path, dist_pri_ind1$pioneer, main="Pioneer species", xlab="Distance from primary forest (m)", ylab="No. trees", ylim=c(0,100), cex=1.5, cex.lab=1.5, cex.axis=1.5, cex.main=1.5)
points(dist_pri_ind3$dist_to_path, dist_pri_ind3$pioneer, pch=4, cex=1.5)
abline(lm(pioneer ~ dist_to_path, data=dist_pri_ind1), lwd=1.5)
abline(lm(pioneer ~ dist_to_path, data=dist_pri_ind3), lty=2, lwd=1.5)
#legend(x=75, y=110, legend=c("2004", "2012"), lty=c(1,2), pch=c(1,4), bty="n", cex=1.5, pt.cex=1.5)
mtext("b", side=3, line=1, at=5, cex=1.5)
dev.off()
# plot distance from pri forest vs. no. individuals of pioneer & non_pioneer species END




# Ripley's K and O-ring statistic using CTFSRPackage # census 1 only
source("/Users/KangMin/Dropbox/secplot_recovery/R codes/RipUvK_KM.R") # load edited script
# remove AAAAAA and species with only one individual
sec1.notalone.sp <- table(sec1.alive$sp)[-1]
sec1.notalone.sp <- sec1.notalone.sp[!(sec1.notalone.sp==1)]
# subset species that are not alone
sec1.notalone <- subset(sec1.alive, sp %in% names(sec1.notalone.sp))
# separate by sp_class2
sec1.pio <- subset(sec1.notalone, sp_class2 == "pioneer")
sec1.nonpio <- subset(sec1.notalone, sp_class2 == "non_pioneer")
sec1.exo <- subset(sec1.notalone, sp_class2 == "exotic")
# calculation of K & O
library(splancs)
sec1.split.pio <- split.data(sec1.pio)
sec1.split.nonpio <- split.data(sec1.nonpio)
sec1.split.exo <- split.data(sec1.exo)
rip_K_O.pio <- RipUvK_KM(sec1.split.pio) 
rip_K_O.nonpio <- RipUvK_KM(sec1.split.nonpio) 
rip_K_O.exo <- RipUvK_KM(sec1.split.exo) 
# plot Ripley's K for species filtered above, separated by sp_class2
png("/Users/KangMin/Dropbox/secplot_recovery/figures/RipleyK 2004.png", width = 700, height = 1000, res = 150)
par(mfrow=c(2,1))
plot(x=c(5,10,20,30,40), y=c(1:5), ylim=c(0,40000), type = "n", xlab = "Distance (m)", ylab = "Ripley's K", main = "Pioneer species (2004)")
for (i in 1:length(rip_K_O.pio$K)){
  lines(x=c(5,10,20,30,40), y=unlist(rip_K_O.pio$K[i])[1:5], ylim=c(0,40000), type = "l", col = "grey")
}
plot(x=c(5,10,20,30,40), y=c(1:5), ylim=c(0,40000), type = "n", xlab = "Distance (m)", ylab = "Ripley's K", main = "Non-pioneer species (2004)")
for (i in 1:length(rip_K_O.nonpio$K)){
  lines(x=c(5,10,20,30,40), y=unlist(rip_K_O.nonpio$K[i])[1:5], ylim=c(0,40000), type = "l", col = "grey")
}
dev.off()
plot(x=c(5,10,20,30,40), y=unlist(rip_K_O.exo$K[i])[1:5], ylim=c(0,40000), type = "l", xlab = "Distance (m)", ylab = "Ripley's K", col = "grey")
# plot O-statistic for species filtered above, separated by sp_class2
png("/Users/KangMin/Dropbox/secplot_recovery/figures/O-statistic 2004.png", width = 700, height = 1000, res = 150)
par(mfrow=c(2,1))
plot(x=c(5,10,20,30,40), y=c(1:5), ylim=c(0,2200), type = "n", xlab = "Distance (m)", ylab = "O-statistic", main = "Pioneer species (2004)")
for (i in 1:length(rip_K_O.pio$O)){
  lines(x=c(5,10,20,30,40), y=unlist(rip_K_O.pio$O[i])[1:5], ylim=c(0,2200), type = "l", col = "grey")
}
plot(x=c(5,10,20,30,40), y=c(1:5), ylim=c(0,2200), type = "n", xlab = "Distance (m)", ylab = "O-statistic", main = "Non-pioneer species (2004)")
for (i in 1:length(rip_K_O.nonpio$O)){
  lines(x=c(5,10,20,30,40), y=unlist(rip_K_O.nonpio$O[i])[1:5], ylim=c(0,2200), type = "l", col = "grey")
}
dev.off()
plot(x=c(5,10,20,30,40), y=unlist(rip_K_O.exo$O[i])[1:5], ylim=c(0,2200), type = "l", xlab = "Distance (m)", ylab = "O-statistic", col = "grey")
# Ripley's K and O-ring statistic # census 1 only END




# n-nearest neighbour # census 1 only
neighbour3 = function(x){mean(sort(x)[1:3], na.rm=T)} # mean distance of nearest 3 neighbours from each individual 
neighbour5 = function(x){mean(sort(x)[1:5], na.rm=T)} # mean distance of nearest 5 neighbours from each individual 
conspec.dist3.pio <- list(); conspec.dist3.nonpio <- list()
conspec.dist5.pio <- list(); conspec.dist5.nonpio <- list()
for (i in 1:length(sec1.split.pio)){
  a <- as.matrix(dist(sec1.split.pio[[i]][,6:7], diag = T, upper = T))
  diag(a) <- NA
  conspec.dist3.pio[[i]] <- apply(a, 1, neighbour3) 
  conspec.dist5.pio[[i]] <- apply(a, 1, neighbour5) 
}
for (i in 1:length(sec1.split.nonpio)){
  a <- as.matrix(dist(sec1.split.nonpio[[i]][,6:7], diag = T, upper = T))
  diag(a) <- NA
  conspec.dist3.nonpio[[i]] <- apply(a, 1, neighbour3)
  conspec.dist5.nonpio[[i]] <- apply(a, 1, neighbour5)
}
summary(unlist(lapply(conspec.dist3.pio, mean)))
summary(unlist(lapply(conspec.dist3.nonpio, mean)))
summary(unlist(lapply(conspec.dist5.pio, mean)))
summary(unlist(lapply(conspec.dist5.nonpio, mean)))


apply(temp1, 1, min, na.rm=T) # nearest neighbour from each individual 
# n-nearest neighbour # census 1 only END





# Joe's suggestion # plot a 3-D map of distance from primary forest, area of primary forest within x-distance radius, and no. individuals
# not quite what Joe had in mind
library(plotly)
Sys.setenv("plotly_username"="ngokangmin")
Sys.setenv("plotly_api_key"="khG2nDJ6JFXQALlCFKup")
plot(dist_pri_ind1$dist_to_path, dist_pri_ind1$buffer_100m)
p <- plot_ly(dist_pri_ind, x = ~dist_to_path, y = ~buffer_100m_percent, z = ~non_pioneer, color = ~census, colors = c('#BF382A', '#0C4B8E')) %>% add_markers() %>% layout(scene = list(xaxis = list(title = 'Distance to primary forest of quadrat (m)'), yaxis = list(title = 'Percentage of primary forest within 100m radius of quadrat'), zaxis = list(title = 'No. non-pioneer species trees')))
p
api_create(p, filename = "dist-area_pri_forest")
# using dispersal kernels
# first analyse dispersal patterns in pri plot # run first 200 lines from priplot dynamics.R
# SHORCU
shorcu6_sap <- subset(pri6, sp == "SHORCU" & dbh <= 20)
shorcu6_adu <- subset(pri6, sp == "SHORCU" & dbh >= 400)
par(xaxs = "i", yaxs = "i")
plot(shorcu6_adu$gx, shorcu6_adu$gy, xlim = c(0,200), ylim = c(0,100), asp = 1, pch=16, cex=2)
points(shorcu6_sap$gx, shorcu6_sap$gy)

# Joe's suggestion END



# species maps # refer to species_maps.R











# old stuff
summary(lm(PF ~ dist_to_path, data=dist_pri_ind1))
summary(lm(PF ~ dist_to_path, data=dist_pri_ind3)) # gradient was stronger in 2012 than in 2004
summary(lm(PFSF ~ dist_to_path, data=dist_pri_ind1))
summary(lm(PFSF ~ dist_to_path, data=dist_pri_ind3)) # slope became a little more gentle, intercept got higher, meaning that number of individuals has increased
summary(lm(SF ~ dist_to_path, data=dist_pri_ind1))
summary(lm(SF ~ dist_to_path, data=dist_pri_ind3)) # no significant gradient for sec forest species
# lm assumes independence of data points, which is not the case for secplot
# lme with random effects is not necessary?? 
# need to use lme to model
library(nlme)
# get best spatial correlation structure # still don't understand what I'm doing here
dist_pri_ind1$dummy <- rep(1, nrow(dist_pri_ind1))
null.model <- lme(fixed = PF ~ 1, data = dist_pri_ind1, random = ~ 1 | dummy) 
cs1Exp <- corExp(1, form = ~ X + Y)
cs1Exp <- Initialize(cs1Exp, dist_pri_ind1)
exp.sp <- update(null.model, correlation = corExp(1, form = ~ X + Y), method = "ML")
gau.sp <- update(null.model, correlation = corGaus(1, form = ~ X + Y), method = "ML")
sph.sp <- update(null.model, correlation = corSpher(1, form = ~ X + Y), method = "ML")
summary(null.model)$AIC
summary(exp.sp)$AIC
summary(gau.sp)$AIC
summary(sph.sp)$AIC # lowest AIC
# get best spatial correlation structure END
PF.model <- lme(fixed = PF ~ dist_to_path, data = dist_pri_ind1, random = ~ 1 | dummy, method="ML")
summary(PF.model)
PF.sph <- update(PF.model, correlation = corSpher(1, form = ~ X + Y), method = "ML")
summary(PF.sph)
# lme END
# Moran's test for spatial autocorrelation
library(spdep)
sec_coords <- read.csv("C:/Users/nkmst/Dropbox/secplot_recovery/R codes/sec_coords.csv") 
coords <- subset(sec_coords, !(quadrat %in% exclude))
secquad.knn <- knearneigh(as.matrix(coords[,c("X","Y")]), k=4) # create nearest neighbours object
secquad.nb <- knn2nb(secquad.knn) # create neighbours list object
moran.test(dist_pri_ind1$PF, nb2listw(secquad.nb, style="W")) # test for spatial autocorrelation of PF individuals
moran.test(dist_pri_ind1$PFSF, nb2listw(secquad.nb, style="W")) # test for spatial autocorrelation of PFSF individuals
moran.test(dist_pri_ind1$SF, nb2listw(secquad.nb, style="W")) # test for spatial autocorrelation of SF individuals
# all species types are spatially autocorrelated, not very useful
# plot distance from pri forest vs. no. individuals of PF and PFSF species
png("/Users/KangMin/Dropbox/secplot_recovery/figures/dist_pri_PF_PFSF_SF_ind.png", width=450, height=1000, res=100)
par(mfrow=c(3,1))
plot(dist_pri_ind1$dist_to_path, dist_pri_ind1$PF, main="Primary forest species", xlab="Distance from primary forest (m)", ylab="No. trees", ylim=c(0,100), cex=1.5, cex.lab=1.5, cex.axis=1.5, cex.main=1.5)
points(dist_pri_ind3$dist_to_path, dist_pri_ind3$PF, pch=4, cex=1.5)
abline(lm(PF ~ dist_to_path, data=dist_pri_ind1), lwd=1.5)
abline(lm(PF ~ dist_to_path, data=dist_pri_ind3), lty=2, lwd=1.5)
legend(x=70, y=110, legend=c("2004", "2012"), lty=c(1,2), pch=c(1,4), bty="n", cex=1.5, pt.cex=1.5)
mtext("a", side=3, line=1, at=5, cex=1.5)
plot(dist_pri_ind1$dist_to_path, dist_pri_ind1$PFSF, main="Generalist species", xlab="Distance from primary forest (m)", ylab="No. trees", ylim=c(0,100), cex=1.5, cex.lab=1.5, cex.axis=1.5, cex.main=1.5)
points(dist_pri_ind3$dist_to_path, dist_pri_ind3$PFSF, pch=4, cex=1.5)
abline(lm(PFSF ~ dist_to_path, data=dist_pri_ind1), lwd=1.5)
abline(lm(PFSF ~ dist_to_path, data=dist_pri_ind3), lty=2, lwd=1.5)
legend(x=75, y=110, legend=c("2004", "2012"), lty=c(1,2), pch=c(1,4), bty="n", cex=1.5, pt.cex=1.5)
mtext("b", side=3, line=1, at=5, cex=1.5)
plot(dist_pri_ind1$dist_to_path, dist_pri_ind1$SF, main="Secondary forest species", xlab="Distance from primary forest (m)", ylab="No. trees", ylim=c(0,100), cex=1.5, cex.lab=1.5, cex.axis=1.5, cex.main=1.5)
points(dist_pri_ind3$dist_to_path, dist_pri_ind3$SF, pch=4, cex=1.5)
abline(lm(SF ~ dist_to_path, data=dist_pri_ind1), lwd=1.5)
abline(lm(SF ~ dist_to_path, data=dist_pri_ind3), lty=2, lwd=1.5)
legend(x=75, y=110, legend=c("2004", "2012"), lty=c(1,2), pch=c(1,4), bty="n", cex=1.5, pt.cex=1.5)
mtext("c", side=3, line=1, at=5, cex=1.5)
dev.off()
# plot distance from pri forest vs. no. individuals of PF and PFSF species END
# for poster
png("C:/Users/nkmst/Dropbox/secplot_recovery/ESJ_2017_poster/dist from primary forest ind.png", width=650, height=600)
par(mar=c(5.1, 5.1, 4.1, 2.1))
plot(dist_pri_ind1$dist_to_path, dist_pri_ind1$PF, main="No. trees", xlab="Distance from primary forest (m)", ylab="No. primary forest species trees", ylim=c(0,100), cex=2, cex.axis = 2, cex.lab=2, cex.main=2)
points(dist_pri_ind3$dist_to_path, dist_pri_ind3$PF, pch=4, cex=2)
abline(lm(PF ~ dist_to_path, data=dist_pri_ind1), lwd=2)
abline(lm(PF ~ dist_to_path, data=dist_pri_ind3), lty=2, lwd=2)
legend(x=80, y=100, legend=c("2004", "2012"), lty=c(1,2), pch=c(1,4), bty="n", cex=2, lwd=2)
dev.off()
# plot distance from primary forest vs no. PF species individuals END
# plot distance from primary forest vs no. PF species 
dist_to_pri <- read.csv("C:/Users/nkmst/Dropbox/secplot_recovery/R codes/dist_to_rock_catchment_path.csv")
dist_pri <- subset(dist_to_pri, !(quadrat %in% exclude))
dist_pri <- dist_pri[order(dist_pri$quadrat),]
quad_sp1 <- tapply(sec1.alive$sp, list(sec1.alive$sp, sec1.alive$quadrat), length)
quad_sp1[is.na(quad_sp1)] <- 0
quad_sp3 <- tapply(sec3.alive$sp, list(sec3.alive$sp, sec3.alive$quadrat), length)
quad_sp3[is.na(quad_sp3)] <- 0
quad_no_sp1 <- matrix(data=0, nrow=4, ncol=nrow(dist_pri))
quad_no_sp3 <- matrix(data=0, nrow=4, ncol=nrow(dist_pri))
dimnames(quad_no_sp1) <- list(c("EX", "PF", "PFSF", "SF"), dist_pri$quadrat)
dimnames(quad_no_sp3) <- list(c("EX", "PF", "PFSF", "SF"), dist_pri$quadrat)
for (i in 1:nrow(dist_pri)){
  temp1 <- quad_sp1[,i]
  temp2 <- quad_sp3[,i]
  temp3 <- temp1[temp1>0]
  temp4 <- temp2[temp2>0]
  quad_no_sp1[,i] <- table(sp_class[match(names(temp3), sp_class$sp),]$class)
  quad_no_sp3[,i] <- table(sp_class[match(names(temp4), sp_class$sp),]$class)
}
dist_pri_sp1 <- cbind(dist_pri, t(quad_no_sp1))
dist_pri_sp3 <- cbind(dist_pri, t(quad_no_sp3))
summary(lm(PF ~ dist_to_path, data=dist_pri_sp1))
summary(lm(PF ~ dist_to_path, data=dist_pri_sp3)) # gradient was slightly stronger in 2012 than in 2004
plot(dist_pri_sp1$dist_to_path, dist_pri_sp1$PF, xlab="Distance from primary forest (m)", ylab="No. primary forest species")
abline(lm(PF ~ dist_to_path, data=dist_pri_sp1))
# plot for poster
png("C:/Users/nkmst/Dropbox/secplot_recovery/ESJ_2017_poster/dist from primary forest sp.png", width=650, height=600)
par(mar=c(5.1, 5.1, 4.1, 2.1))
plot(dist_pri_sp1$dist_to_path, dist_pri_sp1$PF, main="No. species", xlab="Distance from primary forest (m)", ylab="No. primary forest species", ylim=c(0,30), cex=2, cex.axis = 2, cex.lab=2, cex.main=2)
points(dist_pri_sp3$dist_to_path, dist_pri_sp3$PF, pch=4, cex=2)
abline(lm(PF ~ dist_to_path, data=dist_pri_sp1), lwd=2)
abline(lm(PF ~ dist_to_path, data=dist_pri_sp3), lty=2, lwd=2)
legend(x=80, y=30, legend=c("2004", "2012"), lty=c(1,2), pch=c(1,4), bty="n", cex=2, lwd=2)
dev.off()
# plot distance from primary forest vs no. PF species END
# old stuff END



# comparison of same species in primary and secondary forest in 2003/2004 and 2012
# STREEL, SHORCU, CALOBM, CALOPC, IXONRE, TIMOWA
# no. individuals
nrow(subset(pri4, sp=="STREEL" & status=="A")); nrow(subset(pri6, sp=="STREEL" & status=="A"))
nrow(subset(pri4, sp=="SHORCU" & status=="A")); nrow(subset(pri6, sp=="SHORCU" & status=="A"))
nrow(subset(pri4, sp=="CALOBM" & status=="A")); nrow(subset(pri6, sp=="CALOBM" & status=="A"))
nrow(subset(pri4, sp=="CALOPC" & status=="A")); nrow(subset(pri6, sp=="CALOPC" & status=="A"))
nrow(subset(pri4, sp=="IXONRE" & status=="A")); nrow(subset(pri6, sp=="IXONRE" & status=="A"))
nrow(subset(pri4, sp=="TIMOWA" & status=="A")); nrow(subset(pri6, sp=="TIMOWA" & status=="A"))
n_streel_secplot <- nrow(subset(sec1.alive, sp=="STREEL")); nrow(subset(sec3.alive, sp=="STREEL"))
n_shorcu_secplot <- nrow(subset(sec1.alive, sp=="SHORCU")); nrow(subset(sec3.alive, sp=="SHORCU"))
n_calobm_secplot <- nrow(subset(sec1.alive, sp=="CALOBM")); nrow(subset(sec3.alive, sp=="CALOBM"))
n_calopc_secplot <- nrow(subset(sec1.alive, sp=="CALOPC")); nrow(subset(sec3.alive, sp=="CALOPC"))
n_ixonre_secplot <- nrow(subset(sec1.alive, sp=="IXONRE")); nrow(subset(sec3.alive, sp=="IXONRE"))
n_timowa_secplot <- nrow(subset(sec1.alive, sp=="TIMOWA")); nrow(subset(sec3.alive, sp=="TIMOWA"))
# growth rates
g_pri_streel <- growth.indiv(subset(pri4, sp=="STREEL"), subset(pri6, sp=="STREEL"))
g_pri_shorcu <- growth.indiv(subset(pri4, sp=="SHORCU"), subset(pri6, sp=="SHORCU"))
g_pri_calobm <- growth.indiv(subset(pri4, sp=="CALOBM"), subset(pri6, sp=="CALOBM"))
g_pri_calopc <- growth.indiv(subset(pri4, sp=="CALOPC"), subset(pri6, sp=="CALOPC"))
g_pri_ixonre <- growth.indiv(subset(pri4, sp=="IXONRE"), subset(pri6, sp=="IXONRE"))
g_pri_timowa <- growth.indiv(subset(pri4, sp=="TIMOWA"), subset(pri6, sp=="TIMOWA"))
g_sec_streel <- growth.indiv(subset(sec1, sp=="STREEL"), subset(sec3, sp=="STREEL"))
g_sec_shorcu <- growth.indiv(subset(sec1, sp=="SHORCU"), subset(sec3, sp=="SHORCU"))
g_sec_calobm <- growth.indiv(subset(sec1, sp=="CALOBM"), subset(sec3, sp=="CALOBM"))
g_sec_calopc <- growth.indiv(subset(sec1, sp=="CALOPC"), subset(sec3, sp=="CALOPC"))
g_sec_ixonre <- growth.indiv(subset(sec1, sp=="IXONRE"), subset(sec3, sp=="IXONRE"))
g_sec_timowa <- growth.indiv(subset(sec1, sp=="TIMOWA"), subset(sec3, sp=="TIMOWA"))
streel_g <- rbind(cbind(g_pri_streel, plot=rep("pri", nrow(g_pri_streel))), cbind(g_sec_streel, plot=rep("sec", nrow(g_sec_streel)))); streel_g$incgr[streel_g$incgr>10] <- NA # these 2 are most likely a typo error
shorcu_g <- rbind(cbind(g_pri_shorcu, plot=rep("pri", nrow(g_pri_shorcu))), cbind(g_sec_shorcu, plot=rep("sec", nrow(g_sec_shorcu))))
# ANCOVA to test for differences in growth between pri and sec plot, using dbh as a covariate
summary(lm(incgr ~ plot * dbh1, data=streel_g))
summary(aov(incgr ~ plot * dbh1, data=streel_g))
summary(lm(incgr ~ plot * dbh1, data=shorcu_g))
summary(aov(incgr ~ plot * dbh1, data=shorcu_g))
# examine plots for each species
library(ggplot2)
ggplot(streel_g, aes(plot, incgr)) + geom_boxplot()
ggplot(streel_g, aes(dbh1, incgr)) + geom_point(aes(col=plot))
ggplot(shorcu_g, aes(plot, incgr)) + geom_boxplot()
ggplot(shorcu_g, aes(dbh1, incgr)) + geom_point(aes(col=plot))
# average sizes
mean(subset(pri6, sp=="STREEL" & status=="A")$dbh, na.rm=T); mean(subset(sec3.alive, sp=="STREEL")$dbh, na.rm=T)
mean(subset(pri6, sp=="SHORCU" & status=="A")$dbh, na.rm=T); mean(subset(sec3.alive, sp=="SHORCU")$dbh, na.rm=T)
mean(subset(pri6, sp=="CALOBM" & status=="A")$dbh, na.rm=T); mean(subset(sec3.alive, sp=="CALOBM")$dbh, na.rm=T)
mean(subset(pri6, sp=="CALOPC" & status=="A")$dbh, na.rm=T); mean(subset(sec3.alive, sp=="CALOPC")$dbh, na.rm=T)
mean(subset(pri6, sp=="IXONRE" & status=="A")$dbh, na.rm=T); mean(subset(sec3.alive, sp=="IXONRE")$dbh, na.rm=T)
mean(subset(pri6, sp=="TIMOWA" & status=="A")$dbh, na.rm=T); mean(subset(sec3.alive, sp=="TIMOWA")$dbh, na.rm=T)
quantile(subset(pri4, sp=="STREEL" & status=="A")$dbh, na.rm=T); quantile(subset(sec1.alive, sp=="STREEL")$dbh, na.rm=T)
quantile(subset(pri4, sp=="SHORCU" & status=="A")$dbh, na.rm=T); quantile(subset(sec1.alive, sp=="SHORCU")$dbh, na.rm=T)
quantile(subset(pri4, sp=="CALOBM" & status=="A")$dbh, na.rm=T); quantile(subset(sec1.alive, sp=="CALOBM")$dbh, na.rm=T)
quantile(subset(pri4, sp=="CALOPC" & status=="A")$dbh, na.rm=T); quantile(subset(sec1.alive, sp=="CALOPC")$dbh, na.rm=T)
quantile(subset(pri4, sp=="IXONRE" & status=="A")$dbh, na.rm=T); quantile(subset(sec1.alive, sp=="IXONRE")$dbh, na.rm=T)
quantile(subset(pri4, sp=="TIMOWA" & status=="A")$dbh, na.rm=T); quantile(subset(sec1.alive, sp=="TIMOWA")$dbh, na.rm=T)
nrow(subset(pri4, sp=="TIMOWA" & dbh<=193)); summary(subset(pri4, sp=="TIMOWA" & dbh<=193)$dbh)
# growth rates after removing large trees, so that growth rate may be comparable between plots
# but this method still produces slightly skewed size distributions, especially median
growth(subset(pri4, sp=="STREEL" & dbh<=240), subset(pri6, tag %in% subset(pri4, sp=="STREEL" & dbh<=240)$tag))
growth(subset(pri4, sp=="SHORCU" & dbh<=205), subset(pri6, tag %in% subset(pri4, sp=="SHORCU" & dbh<=205)$tag))
growth(subset(pri4, sp=="CALOBM" & dbh<=98), subset(pri6, tag %in% subset(pri4, sp=="CALOBM" & dbh<=98)$tag))
growth(subset(pri4, sp=="CALOPC" & dbh<=171), subset(pri6, tag %in% subset(pri4, sp=="CALOPC" & dbh<=171)$tag))
growth(subset(pri4, sp=="TIMOWA" & dbh<=193), subset(pri6, tag %in% subset(pri4, sp=="TIMOWA" & dbh<=193)$tag))
# for STREEL, SHORCU, CALOBM, and CALOPC in priplot, select n_secplot individuals within size range of the same species in secplot, and calculate their growth rates, repeat 100x
g_streel <- numeric(); mean_pri_dbh_streel <- numeric(); median_pri_dbh_streel <- numeric()
g_shorcu <- numeric(); mean_pri_dbh_shorcu <- numeric(); median_pri_dbh_shorcu <- numeric()
g_calobm <- numeric(); mean_pri_dbh_calobm <- numeric(); median_pri_dbh_calobm <- numeric()
g_calopc <- numeric(); mean_pri_dbh_calopc <- numeric(); median_pri_dbh_calopc <- numeric()
for (i in 1:100){
  temp_streel_tags <- subset(pri4, sp=="STREEL" & dbh<=240)[sample(1:nrow(subset(pri4, sp=="STREEL" & dbh<=240)), n_streel_secplot, replace=F),]$tag
  temp_shorcu_tags <- subset(pri4, sp=="SHORCU" & dbh<=240)[sample(1:nrow(subset(pri4, sp=="SHORCU" & dbh<=240)), n_shorcu_secplot, replace=F),]$tag
  temp_calobm_tags <- subset(pri4, sp=="CALOBM" & dbh<=240)[sample(1:nrow(subset(pri4, sp=="CALOBM" & dbh<=240)), n_calobm_secplot, replace=F),]$tag
  temp_calopc_tags <- subset(pri4, sp=="CALOPC" & dbh<=240)[sample(1:nrow(subset(pri4, sp=="CALOPC" & dbh<=240)), n_calopc_secplot, replace=F),]$tag
  g_streel[i] <- growth(subset(pri4, tag %in% temp_streel_tags), subset(pri6, tag %in% temp_streel_tags))$rate
  g_shorcu[i] <- growth(subset(pri4, tag %in% temp_shorcu_tags), subset(pri6, tag %in% temp_shorcu_tags))$rate
  g_calobm[i] <- growth(subset(pri4, tag %in% temp_calobm_tags), subset(pri6, tag %in% temp_calobm_tags))$rate
  g_calopc[i] <- growth(subset(pri4, tag %in% temp_calopc_tags), subset(pri6, tag %in% temp_calopc_tags))$rate
  mean_pri_dbh_streel[i] <- mean(subset(pri4, tag %in% temp_streel_tags)$dbh, na.rm=T)
  mean_pri_dbh_shorcu[i] <- mean(subset(pri4, tag %in% temp_shorcu_tags)$dbh, na.rm=T)
  mean_pri_dbh_calobm[i] <- mean(subset(pri4, tag %in% temp_calobm_tags)$dbh, na.rm=T)
  mean_pri_dbh_calopc[i] <- mean(subset(pri4, tag %in% temp_calopc_tags)$dbh, na.rm=T)
  median_pri_dbh_streel[i] <- median(subset(pri4, tag %in% temp_streel_tags)$dbh, na.rm=T)
  median_pri_dbh_shorcu[i] <- median(subset(pri4, tag %in% temp_shorcu_tags)$dbh, na.rm=T)
  median_pri_dbh_calobm[i] <- median(subset(pri4, tag %in% temp_calobm_tags)$dbh, na.rm=T)
  median_pri_dbh_calopc[i] <- median(subset(pri4, tag %in% temp_calopc_tags)$dbh, na.rm=T)
}
mean(g_streel); mean(g_shorcu); mean(g_calobm); mean(g_calopc)
nrow(subset(pri4, sp=="STREEL" & dbh<=240)); summary(subset(pri4, sp=="STREEL" & dbh<=240)$dbh); summary(subset(sec1.alive, sp=="STREEL")$dbh); mean(mean_pri_dbh_streel); mean(median_pri_dbh_streel)
nrow(subset(pri4, sp=="SHORCU" & dbh<=205)); summary(subset(pri4, sp=="SHORCU" & dbh<=205)$dbh); summary(subset(sec1.alive, sp=="SHORCU")$dbh); mean(mean_pri_dbh_shorcu); mean(median_pri_dbh_shorcu)
nrow(subset(pri4, sp=="CALOBM" & dbh<=98)); summary(subset(pri4, sp=="CALOBM" & dbh<=98)$dbh); summary(subset(sec1.alive, sp=="CALOBM")$dbh); mean(mean_pri_dbh_calobm); mean(median_pri_dbh_calobm)
nrow(subset(pri4, sp=="CALOPC" & dbh<=171)); summary(subset(pri4, sp=="CALOPC" & dbh<=171)$dbh); summary(subset(sec1.alive, sp=="CALOPC")$dbh); mean(mean_pri_dbh_calopc); mean(median_pri_dbh_calopc)
# mortality rates 
mortality(subset(pri4, sp=="STREEL"), subset(pri6, sp=="STREEL"))
mortality(subset(pri4, sp=="SHORCU"), subset(pri6, sp=="SHORCU"))
mortality(subset(pri4, sp=="CALOBM"), subset(pri6, sp=="CALOBM"))
mortality(subset(pri4, sp=="CALOPC"), subset(pri6, sp=="CALOPC"))
mortality(subset(pri4, sp=="IXONRE"), subset(pri6, sp=="IXONRE"))
mortality(subset(pri4, sp=="TIMOWA"), subset(pri6, sp=="TIMOWA"))
mortality(subset(sec1, sp=="STREEL"), subset(sec3, sp=="STREEL"))
mortality(subset(sec1, sp=="SHORCU"), subset(sec3, sp=="SHORCU"))
mortality(subset(sec1, sp=="CALOBM"), subset(sec3, sp=="CALOBM"))
mortality(subset(sec1, sp=="CALOPC"), subset(sec3, sp=="CALOPC"))
mortality(subset(sec1, sp=="IXONRE"), subset(sec3, sp=="IXONRE"))
mortality(subset(sec1, sp=="TIMOWA"), subset(sec3, sp=="TIMOWA"))
# recruitment rates
recruitment(subset(pri4, sp=="STREEL"), subset(pri6, sp=="STREEL"))
recruitment(subset(pri4, sp=="SHORCU"), subset(pri6, sp=="SHORCU"))
recruitment(subset(pri4, sp=="CALOBM"), subset(pri6, sp=="CALOBM"))
recruitment(subset(pri4, sp=="CALOPC"), subset(pri6, sp=="CALOPC"))
recruitment(subset(pri4, sp=="IXONRE"), subset(pri6, sp=="IXONRE"))
recruitment(subset(pri4, sp=="TIMOWA"), subset(pri6, sp=="TIMOWA"))
recruitment(subset(sec1, sp=="STREEL"), subset(sec3, sp=="STREEL"))
recruitment(subset(sec1, sp=="SHORCU"), subset(sec3, sp=="SHORCU"))
recruitment(subset(sec1, sp=="CALOBM"), subset(sec3, sp=="CALOBM"))
recruitment(subset(sec1, sp=="CALOPC"), subset(sec3, sp=="CALOPC"))
recruitment(subset(sec1, sp=="IXONRE"), subset(sec3, sp=="IXONRE"))
recruitment(subset(sec1, sp=="TIMOWA"), subset(sec3, sp=="TIMOWA"))
# comparison of same species in primary and secondary forest END



# Ficus species
ficu1 <- sec1[grep("FICU", sec1$sp),] # all alive
summary(ficu1$dbh) # biggest Ficus tree only 12 cm 
table(ficu1$sp)
ficu3 <- sec3[grep("FICU", sec3$sp),] 
ficu3 <- subset(ficu3, status=="A") # from 85 trees in 2004 to 15 in 2012
table(ficu3$sp)
# Ficus species END








# plot maps of each species class
# 2004
par(xaxs="i", yaxs="i")
png("/Users/KangMin/Dropbox/secplot_recovery/figures/PF_map_2004.png", width=403, height=744)
plot(subset(sec1.alive, sp_class=="PF")$gx, subset(sec1.alive, sp_class=="PF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/PFSF_map_2004.png", width=403, height=744)
plot(subset(sec1.alive, sp_class=="PFSF")$gx, subset(sec1.alive, sp_class=="PFSF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/SF_map_2004.png", width=403, height=744)
plot(subset(sec1.alive, sp_class=="SF")$gx, subset(sec1.alive, sp_class=="SF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/EX_map_2004.png", width=403, height=744)
plot(subset(sec1.alive, sp_class=="EX")$gx, subset(sec1.alive, sp_class=="EX")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
# 2008
par(xaxs="i", yaxs="i")
png("/Users/KangMin/Dropbox/secplot_recovery/figures/PF_map_2008.png", width=403, height=744)
plot(subset(sec2.alive, sp_class=="PF")$gx, subset(sec2.alive, sp_class=="PF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/PFSF_map_2008.png", width=403, height=744)
plot(subset(sec2.alive, sp_class=="PFSF")$gx, subset(sec2.alive, sp_class=="PFSF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/SF_map_2008.png", width=403, height=744)
plot(subset(sec2.alive, sp_class=="SF")$gx, subset(sec2.alive, sp_class=="SF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/EX_map_2008.png", width=403, height=744)
plot(subset(sec2.alive, sp_class=="EX")$gx, subset(sec2.alive, sp_class=="EX")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
# 2012
par(xaxs="i", yaxs="i")
png("/Users/KangMin/Dropbox/secplot_recovery/figures/PF_map_2012.png", width=403, height=744)
plot(subset(sec3.alive, sp_class=="PF")$gx, subset(sec3.alive, sp_class=="PF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/PFSF_map_2012.png", width=403, height=744)
plot(subset(sec3.alive, sp_class=="PFSF")$gx, subset(sec3.alive, sp_class=="PFSF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/SF_map_2012.png", width=403, height=744)
plot(subset(sec3.alive, sp_class=="SF")$gx, subset(sec3.alive, sp_class=="SF")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/figures/EX_map_2012.png", width=403, height=744)
plot(subset(sec3.alive, sp_class=="EX")$gx, subset(sec3.alive, sp_class=="EX")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()
png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/non_pioneer_map_2012.png", width=403, height=744)
plot(subset(sec3.alive, sp_class2=="non_pioneer")$gx, subset(sec3.alive, sp_class2=="non_pioneer")$gy, xlim=c(0,100), ylim=c(0,200), asp=1)
dev.off()





# spatial distribution of species and their mortality/recruitment (taking 8-year mortality/recruitment 2004-2012)

# plot-level spatial distribution patterns of species classes
library(spatstat)
PF1 <- subset(sec1.alive, sp_class=="PF"); PF2 <- subset(sec2.alive, sp_class=="PF"); PF3 <- subset(sec3.alive, sp_class=="PF")
PFSF1 <- subset(sec1.alive, sp_class=="PFSF"); PFSF2 <- subset(sec2.alive, sp_class=="PFSF"); PFSF3 <- subset(sec3.alive, sp_class=="PFSF")
SF1 <- subset(sec1.alive, sp_class=="SF"); SF2 <- subset(sec2.alive, sp_class=="SF"); SF3 <- subset(sec3.alive, sp_class=="SF")
PF1.ppp <- ppp(PF1$gx, PF1$gy, c(0,100), c(0,200)); PF2.ppp <- ppp(PF2$gx, PF2$gy, c(0,100), c(0,200)); PF3.ppp <- ppp(PF3$gx, PF3$gy, c(0,100), c(0,200))
PFSF1.ppp <- ppp(PFSF1$gx, PFSF1$gy, c(0,100), c(0,200)); PFSF2.ppp <- ppp(PFSF2$gx, PFSF2$gy, c(0,100), c(0,200)); PFSF3.ppp <- ppp(PFSF3$gx, PFSF3$gy, c(0,100), c(0,200))
SF1.ppp <- ppp(SF1$gx, SF1$gy, c(0,100), c(0,200)); SF2.ppp <- ppp(SF2$gx, SF2$gy, c(0,100), c(0,200)); SF3.ppp <- ppp(SF3$gx, SF3$gy, c(0,100), c(0,200))
PF1.env <- envelope(PF1.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
PFSF1.env <- envelope(PFSF1.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
SF1.env <- envelope(SF1.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
PF2.env <- envelope(PF2.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
PFSF2.env <- envelope(PFSF2.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
SF2.env <- envelope(SF2.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
PF3.env <- envelope(PF3.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
PFSF3.env <- envelope(PFSF3.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
SF3.env <- envelope(SF3.ppp, fun=Kest,  nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
# plots by year with different sp_classes within year
png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/sp_class_Kest_2004.png", width=850, height=600, res=150)
plot(PF1.env$r, PF1.env$obs, ylim=c(-1, 15), type="l", xlab=expression(italic("r")), ylab=expression(italic("L(t) - t")), main="2004")
polygon(c(PF1.env$r, rev(PF1.env$r)), c(PF1.env$lo, rev(PF1.env$hi)), col="grey", border=NA)
lines(PFSF1.env, lty=2)
# lines(PFSF1.env$r, PFSF1.env$lo, lty=2); lines(PFSF1.env$r, PFSF1.env$hi, lty=2)
lines(SF1.env, lty=3)
# lines(SF1.env$r, SF1.env$lo, lty=3); lines(SF1.env$r, SF1.env$hi, lty=3)
legend(x=-0.5, y=15, legend=c("Primary forest species", "Generalist species", "Secondary forest species"), lty=1:3, bty="n", y.intersp = 0.7)
dev.off()
png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/sp_class_Kest_2008.png", width=850, height=600, res=150)
plot(PF2.env$r, PF2.env$obs, ylim=c(-1, 15), type="l", xlab=expression(italic("r")), ylab=expression(italic("L(t) - t")), main="2008")
polygon(c(PF2.env$r, rev(PF2.env$r)), c(PF2.env$lo, rev(PF2.env$hi)), col="grey", border=NA)
lines(PFSF2.env, lty=2)
# lines(PFSF1.env$r, PFSF1.env$lo, lty=2); lines(PFSF1.env$r, PFSF1.env$hi, lty=2)
lines(SF2.env, lty=3)
# lines(SF1.env$r, SF1.env$lo, lty=3); lines(SF1.env$r, SF1.env$hi, lty=3)
legend(x=-0.5, y=15, legend=c("Primary forest species", "Generalist species", "Secondary forest species"), lty=1:3, bty="n", y.intersp = 0.7)
dev.off()
png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/sp_class_Kest_2012.png", width=850, height=600, res=150)
plot(PF3.env$r, PF3.env$obs, ylim=c(-1, 15), type="l", xlab=expression(italic("r")), ylab=expression(italic("L(t) - t")), main="2012")
polygon(c(PF3.env$r, rev(PF3.env$r)), c(PF3.env$lo, rev(PF3.env$hi)), col="grey", border=NA)
lines(PFSF3.env, lty=2)
# lines(PFSF1.env$r, PFSF1.env$lo, lty=2); lines(PFSF1.env$r, PFSF1.env$hi, lty=2)
lines(SF3.env, lty=3)
# lines(SF1.env$r, SF1.env$lo, lty=3); lines(SF1.env$r, SF1.env$hi, lty=3)
legend(x=-0.5, y=15, legend=c("Primary forest species", "Generalist species", "Secondary forest species"), lty=1:3, bty="n", y.intersp = 0.7)
dev.off()
# plots by year with different sp_classes within year END
# plots by sp_classes in different years
png("C:/Users/nkmst/Dropbox/secplot_recovery/figures/sp_class_Kest.png", width=650, height=1400, res=200)
par(mfrow=c(3,1))
plot(PF1.env$r, PF1.env$obs, ylim=c(-1, 15), type="l", xlab=expression(italic("r")), ylab=expression(italic("L(t) - t")), main="Primary forest species")
polygon(c(PF1.env$r, rev(PF1.env$r)), c(PF1.env$lo, rev(PF1.env$hi)), col="grey", border=NA)
lines(PF2.env, lty=2)
lines(PF3.env, lty=3)
legend(x=-0.5, y=15, legend=c("2004", "2008", "2012"), lty=1:3, bty="n", y.intersp = 0.7)
plot(PFSF1.env$r, PFSF1.env$obs, ylim=c(-1, 15), type="l", xlab=expression(italic("r")), ylab=expression(italic("L(t) - t")), main="Generalist species")
polygon(c(PFSF1.env$r, rev(PFSF1.env$r)), c(PFSF1.env$lo, rev(PFSF1.env$hi)), col="grey", border=NA)
lines(PFSF2.env, lty=2)
lines(PFSF3.env, lty=3)
legend(x=-0.5, y=15, legend=c("2004", "2008", "2012"), lty=1:3, bty="n", y.intersp = 0.7)
plot(SF1.env$r, SF1.env$obs, ylim=c(-1, 15), type="l", xlab=expression(italic("r")), ylab=expression(italic("L(t) - t")), main="Secondary forest species")
polygon(c(SF1.env$r, rev(SF1.env$r)), c(SF1.env$lo, rev(SF1.env$hi)), col="grey", border=NA)
lines(SF2.env, lty=2)
lines(SF3.env, lty=3)
legend(x=-0.5, y=15, legend=c("2004", "2008", "2012"), lty=1:3, bty="n", y.intersp = 0.7)
dev.off()
# plots by sp_classes in different years END
# plot-level spatial distribution patterns of species classes END


# NULL MODEL: random mortality hypothesis # Kenkel 1988
# using all trees across different times, and randomly select n_dead_trees from trees alive at census 1 for each species

# plotting observed vs null hypothesis of complete spatial randomness

# 99% CSR envelopes (999 Monte Carlo simulations) for all trees alive at census 1 # Olano et al. 2009
# 95% envelopes produced by 99 Monte Carlo simulations: Boyden et al. 2005; Lotwick & Silverman 1982

system.time(source("C:/Users/nkmst/Dropbox/secplot_recovery/R codes/load_species.R")) # will take >1 minute
system.time(source("/Users/KangMin/Dropbox/secplot_recovery/R codes/load_species.R")) 

# plotting initial and survived trees together
campau.1.env <- envelope(campau.1.ppp, fun=Kest, nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
dillsu.1.env <- envelope(dillsu.1.ppp, fun=Kest, nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
rhodci.1.env <- envelope(rhodci.1.ppp, fun=Kest, nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
adindu.1.env <- envelope(adindu.1.ppp, fun=Kest, nsim=999, transform = expression(sqrt(./pi) - r), fix.n=T)
par(mfrow=c(2,2))
plot(campau.1.env, legend=F)
lines(x=campau.3_surv.env$r, y=campau.3_surv.env$obs, lty=3)
legend(x=0, y=12, legend=c("initial", "survivors"), lty=c(1,3), bty="n", y.intersp = 0.4)
plot(dillsu.1.env, legend=F, ylim=c(-0.5,5))
lines(x=dillsu.3_surv.env$r, y=dillsu.3_surv.env$obs, lty=3)
plot(rhodci.1.env, legend=F)
lines(x=rhodci.3_surv.env$r, y=rhodci.3_surv.env$obs, lty=3)
plot(adindu.1.env, legend=F, ylim=c(-0.5,7))
lines(x=adindu.3_surv.env$r, y=adindu.3_surv.env$obs, lty=3)
# figures for ESJ 2017 poster
png("/Users/KangMin/Dropbox/secplot_recovery/ESJ_2017_poster/campau_init_surv.png", width=550, height=300)
plot(campau.1.env, legend=F, main=expression(italic("Campnosperma auriculatum")), cex.main=1.5, cex.axis=1.5, cex.lab=1.5, ylab="")
lines(x=campau.3_surv.env$r, y=campau.3_surv.env$obs, lty=3, lwd=2)
mtext(text=expression(italic("L(t) - t")), side=2, line=2, cex=1.5)
legend(x=0, y=12, legend=c("initial (2004)", "survivors in 2012"), lty=c(1,3), lwd=2, bty="n", y.intersp = 0.8, cex=1.5)
text(x=20, y=4, labels="99% confidence envelopes for\n complete spatial randomness")
lines(x=c(20,21), y=c(1,2.5))
dev.off()
png("/Users/KangMin/Dropbox/secplot_recovery/ESJ_2017_poster/dillsu_init_surv.png", width=550, height=300)
plot(dillsu.1.env, legend=F, main=expression(italic("Dillenia suffruticosa")), cex.main=1.5, cex.axis=1.5, cex.lab=1.5, ylab="", ylim=c(-0.5, 5))
lines(x=dillsu.3_surv.env$r, y=dillsu.3_surv.env$obs, lty=3, lwd=2)
mtext(text=expression(italic("L(t) - t")), side=2, line=2, cex=1.5)
arrows(x0=0, y0=2, x1=0, y1=4)
text(x=2, y=4.5, labels="aggregated")
dev.off()
# figures for ESJ 2017 poster END


# 99% envelopes for random mortality hypothesis 

# all surviving trees at census 3 # are surviving trees more regularly spread than expected by random mortality? 
par(mfrow=c(2,2))
plot(campau.3_surv.env, legend=F)
text(x=c(1,1), y=c(10,8), labels=c(expression("N"[initial]), expression("N"[survived])), adj=c(0,NA))
text(x=c(5,5), y=c(10,8), labels=c("=200", "=159"), adj=c(0,NA))
plot(dillsu.3_surv.env, legend=F)
text(x=c(1,1), y=c(4.3,3.8), labels=c(expression("N"[initial]), expression("N"[survived])), adj=c(0,NA))
text(x=c(5,5), y=c(4.3,3.8), labels=c("=780", "=521"), adj=c(0,NA))
plot(rhodci.3_surv.env, legend=F)
text(x=c(1,1), y=c(4.7,4.2), labels=c(expression("N"[initial]), expression("N"[survived])), adj=c(0,NA))
text(x=c(5,5), y=c(4.7,4.2), labels=c("=149", "=141"), adj=c(0,NA))
plot(adindu.3_surv.env, legend=F)
text(x=c(1,1), y=c(6,5), labels=c(expression("N"[initial]), expression("N"[survived])), adj=c(0,NA))
text(x=c(5,5), y=c(6,5), labels=c("=471", "=375"), adj=c(0,NA))

# all trees that died by census 3 # are dead trees randomly distributed? 
par(mfrow=c(1,2))
plot(campau.3_dead.env, legend=F)
text(x=c(1,1), y=c(20,17), labels=c(expression("N"[initial]), expression("N"[dead])), adj=c(0,NA))
text(x=c(5,5), y=c(20,17), labels=c("=200", "=41"), adj=c(0,NA))
plot(dillsu.3_dead.env, legend=F)
text(x=c(1,1), y=c(5.3,4.6), labels=c(expression("N"[initial]), expression("N"[dead])), adj=c(0,NA))
text(x=c(5,5), y=c(5.3,4.6), labels=c("=780", "=280"), adj=c(0,NA))
plot(rhodci.3_dead.env, legend=F)
text(x=c(1,1), y=c(-15,-20), labels=c(expression("N"[initial]), expression("N"[dead])), adj=c(0,NA))
text(x=c(5,5), y=c(-15,-20), labels=c("=149", "=9"), adj=c(0,NA))
plot(adindu.3_dead.env, legend=F)
text(x=c(1,1), y=c(10,9), labels=c(expression("N"[initial]), expression("N"[dead])), adj=c(0,NA))
text(x=c(5,5), y=c(10,9), labels=c("=471", "=96"), adj=c(0,NA))


PatList <- list()
for (i in 1:99) PatList[[i]] <- runifpoint(npoints(campau.1.ppp), win=owin(c(0,100), c(0,200)))
campau.1.env <- envelope(campau.1.ppp, fun=Kest, simulate = PatList, transform = expression(sqrt(./pi) - r)) # already using default correction "isotropic" Ripley (1988) book
# plot CAMPAU dead trees only
campau.3_dead.env_CSR <- envelope(campau.3_dead.ppp, fun=Kest, transform=expression(sqrt(./pi) - r))
plot(campau.3_dead.env$r, campau.3_dead.env$obs, type="l", ylim=c(-10,20), xlab=expression(italic("r")), ylab=expression(italic("L(r) - r")))
lines(campau.3_dead.env_CSR$r, campau.3_dead.env_CSR$lo, lty=2)
lines(campau.3_dead.env_CSR$r, campau.3_dead.env_CSR$hi, lty=2)
lines(campau.3_dead.env$r, campau.3_dead.env$lo, lty=3)
lines(campau.3_dead.env$r, campau.3_dead.env$hi, lty=3)
legend(x=0, y=20, legend=c(expression(paste(italic("C. auriculatum"), " dead trees")), "complete spatial randomness", "random mortality"), lty=c(1:3), bty="n")
# figure for poster # not used
png("/Users/KangMin/Dropbox/secplot_recovery/ESJ_2017_poster/CAMPAU_dead_spatial.png", width=1000, height=600)
par(mar=c(5.1, 5.1, 4.1, 2.1))
plot(campau.3_dead.env$r, campau.3_dead.env$obs, type="l", ylim=c(-10,20), xlab=expression(italic("r")), ylab=expression(italic("L(r) - r")), main=expression(paste(italic("Campnosperma auriculatum"), " dead trees")), lwd=2, cex.lab=2, cex.axis=2, cex.main=2)
lines(campau.3_dead.env_CSR$r, campau.3_dead.env_CSR$lo, lwd=2, col="brown2")
lines(campau.3_dead.env_CSR$r, campau.3_dead.env_CSR$hi, lwd=2, col="brown2")
lines(campau.3_dead.env$r, campau.3_dead.env$lo, lwd=2, col="blue")
lines(campau.3_dead.env$r, campau.3_dead.env$hi, lwd=2, col="blue")
legend(x=0, y=20, legend=c("observed", "complete spatial randomness", "random mortality"), bty="n", lwd=2, cex=1.5, col=c("black", "brown2", "blue"))
arrows(0, 6, 0, 12, lwd=1.5); arrows(0, -4, 0, -10, lwd=1.5)
text(2, 9, labels="aggregated", cex=2); text(1.5, -7, labels="regular", cex=2)
dev.off()
# figure for poster END
# plot(campau.3_surv.env, legend=F)
# plot(campau.3_dead.env, legend=F)
# plot CAMPAU dead trees only END



# using Kcross function      # this is not the suitable method to test for random mortality, because mortality is intrinsically dependent on previous living trees, while the test simulates random positions of surviving vs dead trees

# using Kcross function to look at dependence of dead tree distribution on surviving tree distribution # basically all of them will have significant dependence at almost all scales because the dead trees clustered with the surviving trees in the first place
# put surviving and dead trees at 2012 into one marked planar point pattern object
merged1.3 <- as.data.frame(cbind(sec3, dbh1=sec1$dbh, codes1=sec1$codes, date1=sec1$date, status1=sec1$status))
campau <- subset(merged1.3, sp=="CAMPAU" & status1!="P")
campau.1.3.ppp <- ppp(campau$gx, campau$gy, c(0,100), c(0,200), marks = factor(campau$status))
plot(campau.1.3.ppp)
campau_Kcross <- Kcross(X = campau.1.3.ppp, i="A", j="D")
plot(campau_Kcross)
plot(campau.env <- envelope(campau.1.3.ppp, fun=Kcross, i="A", j="D", fix.n = T, fix.marks=T, transform = expression(sqrt(./pi) - r) )) 
dillsu <- subset(merged1.3, sp=="DILLSU" & status1!="P")
dillsu.1.3.ppp <- ppp(dillsu$gx, dillsu$gy, c(0,100), c(0,200), marks = factor(dillsu$status))
plot(dillsu.1.3.ppp)
dillsu_Kcross <- Kcross(X = dillsu.1.3.ppp, i="A", j="D")
plot(dillsu_Kcross)
plot(dillsu.env <- envelope(dillsu.1.3.ppp, fun=Kcross, i="A", j="D", fix.n = T, fix.marks=T, transform = expression(sqrt(./pi) - r) )) 
# using Kcross function to look at interaction between surviving and dead trees END


# using Kcross function to look at dominant species mortality vs PF species recruitment
# no. individuals dominant species
library(spatstat)
dom_dead <- subset(sec3, sp %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI") & status=="D")
dom_dead$mark <- "dead"
PF_recr <- subset(sec1, sp_class=="PF" & status=="P")
PF_recr$mark <- "recruit"
dead_recr <- rbind(dom_dead, PF_recr)
dead_recr.ppp <- ppp(dead_recr$gx, dead_recr$gy, c(0,100), c(0,200), marks = factor(dead_recr$mark))
plot(Kcross(dead_recr.ppp, i="dead", j="recruit"))
plot(envelope(dead_recr.ppp, fun=Kcross, i="dead", j="recruit", transform = expression(sqrt(./pi) - r)))
# no. individuals dominant species END
# secondary forest species mortality vs recruitment

# secondary forest species mortality vs recruitment END
# using Kcross function to look at dominant species mortality vs PF species recruitment END

# using Kcross function to look at interaction between PF and dom sapling interaction
library(spatstat)
PF_sap1 <- subset(sec1.alive, sp_class=="PF" & size=="[10,50)"); PF_sap1$mark <- "PF"
PF_sap3 <- subset(sec3.alive, sp_class=="PF" & size=="[10,50)"); PF_sap3$mark <- "PF"
dom_sap1 <- subset(sec1.alive, sp %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI") & size=="[10,50)"); dom_sap1$mark <- "dom"
dom_sap3 <- subset(sec3.alive, sp %in% c("CAMPAU", "DILLSU", "ADINDU", "RHODCI") & size=="[10,50)"); dom_sap3$mark <- "dom"
sap1 <- rbind(PF_sap1, dom_sap1)
sap3 <- rbind(PF_sap3, dom_sap3)
sap1.ppp <- ppp(sap1$gx, sap1$gy, c(0,100), c(0,200), marks = factor(sap1$mark))
sap3.ppp <- ppp(sap3$gx, sap3$gy, c(0,100), c(0,200), marks = factor(sap3$mark))
sap1.env <- envelope(sap1.ppp, fun=Kcross, i="PF", j="dom", transform = expression(sqrt(./pi) - r))
sap3.env <- envelope(sap3.ppp, fun=Kcross, i="PF", j="dom", transform = expression(sqrt(./pi) - r))
plot(sap1.env, ylim=c(-0.8, 0.8), legend=F, main="sapling association between primary forest and dominant species")
lines(sap3.env$r, sap3.env$obs, col="blue")
text(x=13, y=0.7, labels="2004")
text(x=19, y=-0.5, labels="2012")
# using Kcross function to look at interaction between PF and dom sapling interaction END




# look at effect of weather 



# test the effect of sample size on K function
# DILLSU mortality 2004-2012 -> 31.1% died
par(mfrow=c(1,3))
plot(dillsu.1.ppp); plot(dillsu.3_surv.ppp); plot(dillsu.3_dead.ppp)
# ADINDU mortality 2004-2012 -> 20.5% died
par(mfrow=c(1,3))
plot(adindu.1.ppp); plot(adindu.3_surv.ppp); plot(adindu.3_dead.ppp)
# CAMPAU mortality 2004-2-12 -> 20.5% died
par(mfrow=c(1,3))
plot(campau.1.ppp); plot(campau.3_surv.ppp); plot(campau.3_dead.ppp)
# using DILLSU to simulate random survivors
library(spatstat)
dillsu <- ppp(x=subset(sec1.alive, sp=="DILLSU")$gx, y=subset(sec1.alive, sp=="DILLSU")$gy, c(0,100), c(0,200))
n.dead <- nrow(subset(sec3, sp=="DILLSU" & status=="D"))
surv <- list()
for (i in 1:999){
  samp_index <- sample(1:dillsu$n, n.dead, replace=F)
  surv[[i]] <- ppp(x=dillsu$x[-samp_index], y=dillsu$y[-samp_index], c(0,100), c(0,200))
}
plot(envelope(dillsu, fun=Kest, transform=expression(sqrt(./pi) - r)), ylim=c(-0.5,5) )
for (i in 1:999){ # lines are for every simulation of survivors from random mortality
  lines(Lest(surv[[i]])$r, Lest(surv[[i]])$iso-Lest(surv[[i]])$r, col="grey")
}
par(new=T)
plot(envelope(dillsu, fun=Kest, transform=expression(sqrt(./pi) - r)), ylim=c(-0.5,5) ) # random mortality could lead to either more or less aggregated distribution than initial
# using CAMPAU to simulate random survivors
campau <- ppp(x=subset(sec1.alive, sp=="CAMPAU")$gx, y=subset(sec1.alive, sp=="CAMPAU")$gy, c(0,100), c(0,200))
n.dead <- nrow(subset(sec3, sp=="CAMPAU" & status=="D"))
surv <- list()
for (i in 1:999){
  samp_index <- sample(1:campau$n, n.dead, replace=F)
  surv[[i]] <- ppp(x=campau$x[-samp_index], y=campau$y[-samp_index], c(0,100), c(0,200))
}
plot(envelope(campau, fun=Kest, transform=expression(sqrt(./pi) - r)), ylim=c(-1,13) )
for (i in 1:999){ # lines are for every simulation of survivors from random mortality
  lines(Lest(surv[[i]])$r, Lest(surv[[i]])$iso-Lest(surv[[i]])$r, col="grey")
}
par(new=T)
plot(envelope(campau, fun=Kest, transform=expression(sqrt(./pi) - r)), ylim=c(-1,13) ) # random mortality could lead to either more or less aggregated distribution than initial

# test the effect of sample size on K function END







